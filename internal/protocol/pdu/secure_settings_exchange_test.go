package pdu

import (
	"testing"

	"github.com/stretchr/testify/require"
)

func TestSystemTime_Serialize(t *testing.T) {
	st := SystemTime{
		Year:         2024,
		Month:        6,
		DayOfWeek:    4,
		Day:          15,
		Hour:         10,
		Minute:       30,
		Second:       45,
		Milliseconds: 500,
	}

	data := st.Serialize()
	require.Len(t, data, 16) // 8 uint16 values

	// Check Year (little-endian)
	require.Equal(t, byte(0xE8), data[0]) // 2024 & 0xFF
	require.Equal(t, byte(0x07), data[1]) // 2024 >> 8
}

func TestTimeZoneInformation_Serialize(t *testing.T) {
	tzi := TimeZoneInformation{
		Bias:         300,
		StandardBias: 0,
		DaylightBias: 60,
	}

	data := tzi.Serialize()
	require.Len(t, data, 172) // 4 + 64 + 16 + 4 + 64 + 16 + 4

	// Check Bias (little-endian)
	require.Equal(t, byte(0x2C), data[0]) // 300 & 0xFF
	require.Equal(t, byte(0x01), data[1]) // 300 >> 8
}

func TestNewClientInfoPDU_Serialize(t *testing.T) {
	// Test with standard RDP security (includes security header)
	req := NewClientInfo("192.168.1.2", "User", "p@$$w0rd")
	req.InfoPacket.Flags = 0x00010153
	req.InfoPacket.ExtraInfo.PerformanceFlags = 0x0

	expected := []byte{
		0x40, 0x00, 0x00, 0x00, 0x09, 0x04, 0x00, 0x00, 0x53, 0x01, 0x01, 0x00, 0x16, 0x00, 0x08, 0x00,
		0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x31, 0x00, 0x39, 0x00, 0x32, 0x00, 0x2e, 0x00, 0x31, 0x00,
		0x36, 0x00, 0x38, 0x00, 0x2e, 0x00, 0x31, 0x00, 0x2e, 0x00, 0x32, 0x00, 0x00, 0x00, 0x55, 0x00,
		0x73, 0x00, 0x65, 0x00, 0x72, 0x00, 0x00, 0x00, 0x70, 0x00, 0x40, 0x00, 0x24, 0x00, 0x24, 0x00,
		0x77, 0x00, 0x30, 0x00, 0x72, 0x00, 0x64, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00,
		0x02, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	}

	// false = standard RDP security (with header)
	actual := req.Serialize(false)
	require.Equal(t, expected, actual)

	// true = enhanced security (TLS) - now includes header for XRDP compatibility
	// Per code comments: XRDP expects SEC_INFO_PKT security header even with TLS
	actualTLS := req.Serialize(true)
	require.Equal(t, expected, actualTLS) // Same output - header always included for compatibility
}
