var RDP=(()=>{var C=Object.defineProperty;var U=Object.getOwnPropertyDescriptor;var D=Object.getOwnPropertyNames;var I=Object.prototype.hasOwnProperty;var F=(e,t)=>{for(var i in t)C(e,i,{get:t[i],enumerable:!0})},B=(e,t,i,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of D(t))!I.call(e,n)&&n!==i&&C(e,n,{get:()=>t[n],enumerable:!(s=U(t,n))||s.enumerable});return e};var $=e=>B(C({},"__esModule",{value:!0}),e);var H={};F(H,{Client:()=>g,ConnectionHistory:()=>E,FallbackCodec:()=>w,Logger:()=>o,RFXDecoder:()=>v,WASMCodec:()=>u,default:()=>P,isWASMSupported:()=>b});var p={DEBUG:0,INFO:1,WARN:2,ERROR:3,NONE:4},o={level:p.WARN,setLevel(e){let t={debug:p.DEBUG,info:p.INFO,warn:p.WARN,warning:p.WARN,error:p.ERROR,none:p.NONE};this.level=t[e.toLowerCase()]??p.WARN},debug(e,...t){this.level<=p.DEBUG&&console.log(`[${e}]`,...t)},info(e,...t){this.level<=p.INFO&&console.info(`[${e}]`,...t)},warn(e,...t){this.level<=p.WARN&&console.warn(`[${e}]`,...t)},error(e,...t){this.level<=p.ERROR&&console.error(`[${e}]`,...t)},enableDebug(){this.level=p.DEBUG},enableInfo(){this.level=p.INFO},quiet(){this.level=p.ERROR},silent(){this.level=p.NONE}};function z(){let e=new Uint8Array(16);return crypto.getRandomValues(e),"session_"+Array.from(e,i=>i.toString(16).padStart(2,"0")).join("")}var x={initSession(){this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.reconnectDelay=2e3,this.reconnectTimeout=null,this.lastConnectionTime=null,this.manualDisconnect=!1,this.sessionId=z(),this.maxSessionTime=8*60*60*1e3,this.maxIdleTime=30*60*1e3,this.lastActivityTime=null,this.sessionTimeout=null,this.idleTimeout=null,this.warningTimeout=null,this.warningShown=!1,this.loadSession()},shouldAutoReconnect(){return!1},saveSession(){try{let e=new Date(Date.now()+6048e5).toUTCString();document.cookie=`rdp_host=${encodeURIComponent(this.hostEl.value)}; expires=${e}; path=/; SameSite=Strict`,document.cookie=`rdp_user=${encodeURIComponent(this.userEl.value)}; expires=${e}; path=/; SameSite=Strict`}catch(e){o.warn("Session",`Failed to save: ${e.message}`)}},loadSession(){try{let e=document.cookie.split(";").reduce((t,i)=>{let[s,n]=i.trim().split("=");return s&&n&&(t[s]=decodeURIComponent(n)),t},{});e.rdp_host&&(this.hostEl.value=e.rdp_host),e.rdp_user&&(this.userEl.value=e.rdp_user)}catch(e){o.debug("Session",`Failed to load: ${e.message}`)}},verifySessionIntegrity(e){return["host","user","timestamp","sessionId"].every(i=>e.hasOwnProperty(i))},clearSession(){document.cookie="rdp_host=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;",document.cookie="rdp_user=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;",this.manualDisconnect=!0},scheduleReconnect(e){this.reconnectTimeout&&clearTimeout(this.reconnectTimeout),!(this.reconnectAttempts>=this.maxReconnectAttempts||this.manualDisconnect)&&(this.reconnectTimeout=setTimeout(()=>{this.shouldAutoReconnect()&&!this.connected&&(o.debug("Session",`Reconnect attempt ${this.reconnectAttempts+1}/${this.maxReconnectAttempts}`),this.attemptReconnect())},e))},attemptReconnect(){if(!this.hostEl.value||!this.userEl.value)return;if(this.reconnectAttempts++,this.socket&&this.socket.readyState!==WebSocket.CLOSED)try{this.socket.close()}catch{}let e=new URL(this.websocketURL);e.searchParams.set("width",this.canvas.width),e.searchParams.set("height",this.canvas.height),e.searchParams.set("sessionId",this.sessionId);let t=this.passwordEl?this.passwordEl.value:"";this.socket=new WebSocket(e.toString()),this.socket.onopen=()=>{let i=JSON.stringify({type:"credentials",host:this.hostEl.value,user:this.userEl.value,password:t});this.socket.send(i),this.initialize()},this.socket.onmessage=i=>{i.data.arrayBuffer().then(s=>this.handleMessage(s)).catch(s=>o.error("Session",`Failed to read message: ${s.message}`))},this.socket.onerror=i=>{o.warn("Session","Reconnection error")},this.socket.onclose=i=>{if(!this.manualDisconnect&&this.reconnectAttempts<this.maxReconnectAttempts){let s=Math.max(0,this.reconnectAttempts-1),n=this.reconnectDelay*Math.pow(2,s);this.scheduleReconnect(Math.min(n,3e4))}}},startTimeoutTracking(){this.lastConnectionTime=Date.now(),this.lastActivityTime=Date.now(),this.sessionTimeout=setTimeout(()=>{this.handleSessionTimeout()},this.maxSessionTime),this.resetIdleTimeout()},updateActivity(){this.lastActivityTime=Date.now(),this.warningShown=!1;let e=document.getElementById("idle-warning");e&&(e.style.display="none"),this.resetIdleTimeout()},resetIdleTimeout(){this.idleTimeout&&clearTimeout(this.idleTimeout),this.warningTimeout&&clearTimeout(this.warningTimeout),this.warningTimeout=setTimeout(()=>{this.showIdleWarning()},this.maxIdleTime-5*60*1e3),this.idleTimeout=setTimeout(()=>{this.handleIdleTimeout()},this.maxIdleTime)},showIdleWarning(){if(this.warningShown)return;this.warningShown=!0;let e=document.getElementById("idle-warning");e||(e=document.createElement("div"),e.id="idle-warning",e.className="idle-warning",e.innerHTML="Session will disconnect in 5 minutes due to inactivity. Move mouse or press a key to stay connected.",document.body.appendChild(e)),e.style.display="block"},handleIdleTimeout(){o.debug("Session","Disconnected due to inactivity"),this.showUserWarning("Session disconnected due to inactivity"),this.disconnect()},handleSessionTimeout(){o.debug("Session","Maximum session time reached (8 hours)"),this.showUserWarning("Session disconnected - maximum session time reached (8 hours)"),this.disconnect()},clearAllTimeouts(){this.sessionTimeout&&(clearTimeout(this.sessionTimeout),this.sessionTimeout=null),this.idleTimeout&&(clearTimeout(this.idleTimeout),this.idleTimeout=null),this.warningTimeout&&(clearTimeout(this.warningTimeout),this.warningTimeout=null),this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=null)}};function W(e){let t=0,i=0;for(;e&&!isNaN(e.offsetLeft)&&!isNaN(e.offsetTop);)t+=e.offsetLeft-e.scrollLeft,i+=e.offsetTop-e.scrollTop,e=e.offsetParent;return{top:i,left:t}}function T(e){switch(e){case 0:return 1;case 1:return 3;case 2:return 2;default:return 1}}var S={initInput(){this.isDragging=!1,this.inputQueue=[],this.inputFlushPending=!1,this.lastMouseMove=null,this.mouseThrottleMs=16,this.lastMouseSendTime=0,this.lastActivityUpdate=null,this.lastTouchUpdate=null,this.handleKeyDown=this.handleKeyDown.bind(this),this.handleKeyUp=this.handleKeyUp.bind(this),this.handleMouseMove=this.handleMouseMove.bind(this),this.handleMouseDown=this.handleMouseDown.bind(this),this.handleMouseUp=this.handleMouseUp.bind(this),this.handleWheel=this.handleWheel.bind(this),this.handleTouchStart=this.handleTouchStart.bind(this),this.handleTouchMove=this.handleTouchMove.bind(this),this.handleTouchEnd=this.handleTouchEnd.bind(this)},screenToDesktop(e,t){let i=W(this.canvas),s=Math.floor(e-i.left),n=Math.floor(t-i.top);return{x:s,y:n}},queueInput(e,t){t?this.lastMouseMove=e:this.inputQueue.push(e),this.inputFlushPending||(this.inputFlushPending=!0,setTimeout(()=>this.flushInputQueue(),0))},flushInputQueue(){if(this.inputFlushPending=!1,!this.connected||!this.socket||this.socket.readyState!==WebSocket.OPEN){this.inputQueue=[],this.lastMouseMove=null;return}for(;this.inputQueue.length>0;){let t=this.inputQueue.shift();try{this.socket.send(t)}catch{this.inputQueue=[];break}}let e=Date.now();if(this.lastMouseMove&&e-this.lastMouseSendTime>=this.mouseThrottleMs){try{this.socket.send(this.lastMouseMove),this.lastMouseSendTime=e}catch{}this.lastMouseMove=null}else this.lastMouseMove&&(this.inputFlushPending||(this.inputFlushPending=!0,setTimeout(()=>this.flushInputQueue(),this.mouseThrottleMs)))},handleKeyDown(e){if(!this.connected){this.showUserError("Cannot send keystrokes: not connected to server");return}this.updateActivity();let t=new KeyboardEventKeyDown(e.code);if(t.keyCode===void 0)return this.logError("Key mapping error",{code:e.code,key:e.key}),this.showUserError("Unsupported key: "+e.key),e.preventDefault(),!1;try{let i=t.serialize();this.queueInput(i,!1)}catch(i){this.logError("Key send error",{code:e.code,error:i.message}),this.showUserError("Failed to send keystroke")}return e.preventDefault(),!1},handleKeyUp(e){if(!this.connected)return;this.updateActivity();let t=new KeyboardEventKeyUp(e.code);if(t.keyCode===void 0)return o.debug("[Input] Undefined key up:",e.code),e.preventDefault(),!1;let i=t.serialize();return this.queueInput(i,!1),e.preventDefault(),!1},handleMouseMove(e){(!this.lastActivityUpdate||Date.now()-this.lastActivityUpdate>1e3)&&(this.updateActivity(),this.lastActivityUpdate=Date.now());try{let t=this.screenToDesktop(e.clientX,e.clientY),s=new MouseMoveEvent(t.x,t.y).serialize();this.queueInput(s,!0)}catch(t){this.logError("Mouse move error",{x:e.clientX,y:e.clientY,error:t.message})}return e.preventDefault(),!1},handleMouseDown(e){this.updateActivity(),this.isDragging=!0;let t=this.screenToDesktop(e.clientX,e.clientY),s=new MouseDownEvent(t.x,t.y,T(e.button)).serialize();return this.queueInput(s,!1),document.addEventListener("mousemove",this.handleMouseMove),document.addEventListener("mouseup",this.handleMouseUp),e.preventDefault(),!1},handleMouseUp(e){this.isDragging=!1;let t=this.screenToDesktop(e.clientX,e.clientY),s=new MouseUpEvent(t.x,t.y,T(e.button)).serialize();return this.queueInput(s,!1),document.removeEventListener("mousemove",this.handleMouseMove),document.removeEventListener("mouseup",this.handleMouseUp),e.preventDefault(),!1},handleWheel(e){this.updateActivity();let t=this.screenToDesktop(e.clientX,e.clientY),i=Math.abs(e.deltaX)>Math.abs(e.deltaY),s=i?e.deltaX:e.deltaY,n=Math.round(Math.abs(s)*15/8),r=new MouseWheelEvent(t.x,t.y,n,s>0,i).serialize();return this.queueInput(r,!1),e.preventDefault(),!1},handleTouchStart(e){if(!this.connected)return;e.preventDefault(),this.updateActivity();let t=e.touches[0],i={clientX:t.clientX,clientY:t.clientY,button:0,preventDefault:()=>{}};return this.handleMouseDown(i)},handleTouchMove(e){if(this.connected&&(e.preventDefault(),!this.lastTouchUpdate||Date.now()-this.lastTouchUpdate>16)){this.updateActivity(),this.lastTouchUpdate=Date.now();let t=e.touches[0],i={clientX:t.clientX,clientY:t.clientY,preventDefault:()=>{}};return this.handleMouseMove(i)}},handleTouchEnd(e){if(!this.connected)return;e.preventDefault(),this.updateActivity();let t=e.changedTouches[0],i={clientX:t.clientX,clientY:t.clientY,button:0,preventDefault:()=>{}};return this.handleMouseUp(i)},attachInputListeners(){this.canvas.addEventListener("keydown",this.handleKeyDown,!1),this.canvas.addEventListener("keyup",this.handleKeyUp,!1),this.canvas.addEventListener("mousemove",this.handleMouseMove,!1),this.canvas.addEventListener("mousedown",this.handleMouseDown,!1),this.canvas.addEventListener("mouseup",this.handleMouseUp,!1),this.canvas.addEventListener("wheel",this.handleWheel,!1),this.canvas.addEventListener("contextmenu",e=>(e.preventDefault(),!1)),this.canvas.addEventListener("touchstart",this.handleTouchStart,{passive:!1}),this.canvas.addEventListener("touchmove",this.handleTouchMove,{passive:!1}),this.canvas.addEventListener("touchend",this.handleTouchEnd,{passive:!1})},detachInputListeners(){this.canvas.removeEventListener("keydown",this.handleKeyDown),this.canvas.removeEventListener("keyup",this.handleKeyUp),this.canvas.removeEventListener("mousemove",this.handleMouseMove),this.canvas.removeEventListener("mousedown",this.handleMouseDown),this.canvas.removeEventListener("mouseup",this.handleMouseUp),this.canvas.removeEventListener("wheel",this.handleWheel),this.canvas.removeEventListener("touchstart",this.handleTouchStart),this.canvas.removeEventListener("touchmove",this.handleTouchMove),this.canvas.removeEventListener("touchend",this.handleTouchEnd),document.removeEventListener("mousemove",this.handleMouseMove),document.removeEventListener("mouseup",this.handleMouseUp)}};function b(){try{if(typeof WebAssembly=="object"&&typeof WebAssembly.instantiate=="function")return new WebAssembly.Module(new Uint8Array([0,97,115,109,1,0,0,0]))instanceof WebAssembly.Module}catch{}return!1}var u={ready:!1,goInstance:null,wasmInstance:null,supported:b(),initError:null,async init(e="js/rle/rle.wasm"){if(this.ready)return!0;if(!this.supported)return this.initError="WebAssembly not supported in this browser",o.error("WASM",this.initError),!1;try{if(typeof Go>"u")return this.initError="Go class not found. Include wasm_exec.js before initializing.",o.error("WASM",this.initError),!1;this.goInstance=new Go;let t;if(typeof WebAssembly.instantiateStreaming=="function")try{t=await WebAssembly.instantiateStreaming(fetch(e),this.goInstance.importObject)}catch{o.warn("WASM","Streaming failed, using array buffer fallback");let n=await(await fetch(e)).arrayBuffer();t=await WebAssembly.instantiate(n,this.goInstance.importObject)}else{let s=await(await fetch(e)).arrayBuffer();t=await WebAssembly.instantiate(s,this.goInstance.importObject)}return this.wasmInstance=t.instance,this.goInstance.run(this.wasmInstance),typeof goRLE>"u"?(this.initError="goRLE not initialized after running WASM",o.error("WASM",this.initError),!1):(this.ready=!0,this.initError=null,o.debug("WASM","Codec module initialized (RLE + RFX)"),!0)}catch(t){return this.initError=t.message,o.error("WASM",`Failed to initialize: ${t.message}`),!1}},isSupported(){return this.supported},getInitError(){return this.initError},isReady(){return this.ready&&typeof goRLE<"u"},decompressRLE16(e,t,i,s){return this.isReady()?goRLE.decompressRLE16(e,t,i,s):!1},flipVertical(e,t,i,s){this.isReady()&&goRLE.flipVertical(e,t,i,s)},rgb565toRGBA(e,t){this.isReady()&&goRLE.rgb565toRGBA(e,t)},bgr24toRGBA(e,t){this.isReady()&&goRLE.bgr24toRGBA(e,t)},bgra32toRGBA(e,t){this.isReady()&&goRLE.bgra32toRGBA(e,t)},processBitmap(e,t,i,s,n,a,r){return this.isReady()?goRLE.processBitmap(e,t,i,s,n,a,r):!1},decodeNSCodec(e,t,i,s){return this.isReady()?goRLE.decodeNSCodec(e,t,i,s):!1},setPalette(e,t){return this.isReady()?goRLE.setPalette(e,t):!1},setRFXQuant(e){return this.isReady()?goRLE.setRFXQuant(e):!1},decodeRFXTile(e,t){if(!this.isReady())return null;let i=goRLE.decodeRFXTile(e,t);return i==null?null:{x:i[0],y:i[1],width:i[2],height:i[3]}},RFX_TILE_SIZE:64,RFX_TILE_PIXELS:4096,RFX_TILE_RGBA_SIZE:16384},v=class{constructor(){this.tileBuffer=new Uint8Array(u.RFX_TILE_RGBA_SIZE),this.quantBuffer=new Uint8Array(15),this.quantSet=!1}setQuant(t,i,s){this.quantBuffer.set(t,0),this.quantBuffer.set(i,5),this.quantBuffer.set(s,10),this.quantSet=u.setRFXQuant(this.quantBuffer)}setQuantRaw(t){this.quantBuffer.set(t.subarray(0,15)),this.quantSet=u.setRFXQuant(this.quantBuffer)}decodeTile(t){let i=u.decodeRFXTile(t,this.tileBuffer);return i?{x:i.x,y:i.y,width:i.width,height:i.height,rgba:this.tileBuffer}:null}decodeTileToCanvas(t,i){let s=u.decodeRFXTile(t,this.tileBuffer);if(!s)return!1;let n=new ImageData(new Uint8ClampedArray(this.tileBuffer),s.width,s.height);return i.putImageData(n,s.x,s.y),!0}};var w={palette:new Uint8Array(256*4),_lut5to8:null,_lut6to8:null,init(){if(!this._lut5to8){this._lut5to8=new Uint8Array(32);for(let e=0;e<32;e++)this._lut5to8[e]=e<<3|e>>2;this._lut6to8=new Uint8Array(64);for(let e=0;e<64;e++)this._lut6to8[e]=e<<2|e>>4;o.debug("FallbackCodec","Initialized color lookup tables")}},shouldUse16BitColor(){return!0},getRecommendedColorDepth(){return 16},setPalette(e,t){let i=Math.min(t,256);for(let s=0;s<i;s++)this.palette[s*4]=e[s*3],this.palette[s*4+1]=e[s*3+1],this.palette[s*4+2]=e[s*3+2],this.palette[s*4+3]=255},rgb565ToRGBA(e,t){this._lut5to8||this.init();let i=e.length>>1;if(e.length===0)return!0;if(e.length<2)return!1;if(t.length<i*4)return o.warn("FallbackCodec",`rgb565ToRGBA: dst buffer too small (${t.length} < ${i*4})`),!1;let s=this._lut5to8,n=this._lut6to8,a=new DataView(e.buffer,e.byteOffset,e.byteLength);for(let r=0;r<i;r++){let h=a.getUint16(r<<1,!0),c=r<<2;t[c]=s[h>>11&31],t[c+1]=n[h>>5&63],t[c+2]=s[h&31],t[c+3]=255}return!0},rgb565ToRGBA_Fast(e,t){this._lut5to8||this.init();let i=e.length>>1;if(e.length===0)return!0;if(e.length<2)return!1;if(t.length<i*4)return o.warn("FallbackCodec","rgb565ToRGBA_Fast: dst buffer too small"),!1;let s=this._lut5to8,n=this._lut6to8,a=new DataView(e.buffer,e.byteOffset,e.byteLength),r=new DataView(t.buffer,t.byteOffset,t.byteLength);for(let h=0;h<i;h++){let c=a.getUint16(h<<1,!0),d=s[c>>11&31],m=n[c>>5&63],l=s[c&31];r.setUint32(h<<2,255<<24|l<<16|m<<8|d,!0)}return!0},rgb555ToRGBA(e,t){this._lut5to8||this.init();let i=e.length>>1;if(e.length===0)return!0;if(e.length<2)return!1;if(t.length<i*4)return o.warn("FallbackCodec","rgb555ToRGBA: dst buffer too small"),!1;let s=this._lut5to8,n=new DataView(e.buffer,e.byteOffset,e.byteLength);for(let a=0;a<i;a++){let r=n.getUint16(a<<1,!0),h=a<<2;t[h]=s[r>>10&31],t[h+1]=s[r>>5&31],t[h+2]=s[r&31],t[h+3]=255}return!0},palette8ToRGBA(e,t){if(e.length===0)return!0;if(t.length<e.length*4)return o.warn("FallbackCodec","palette8ToRGBA: dst buffer too small"),!1;let i=this.palette;for(let s=0,n=e.length;s<n;s++){let a=e[s]<<2,r=s<<2;t[r]=i[a],t[r+1]=i[a+1],t[r+2]=i[a+2],t[r+3]=i[a+3]}return!0},bgr24ToRGBA(e,t){let i=e.length/3|0;if(e.length===0)return!0;if(e.length<3)return!1;if(t.length<i*4)return o.warn("FallbackCodec","bgr24ToRGBA: dst buffer too small"),!1;for(let s=0;s<i;s++){let n=s*3,a=s<<2;t[a]=e[n+2],t[a+1]=e[n+1],t[a+2]=e[n],t[a+3]=255}return!0},bgra32ToRGBA(e,t){let i=e.length>>2;if(e.length===0)return!0;if(e.length<4)return!1;if(t.length<i*4)return o.warn("FallbackCodec","bgra32ToRGBA: dst buffer too small"),!1;let s=new DataView(e.buffer,e.byteOffset,e.byteLength),n=new DataView(t.buffer,t.byteOffset,t.byteLength);for(let a=0;a<i;a++){let r=a<<2,h=s.getUint32(r,!0),c=h&255,d=h>>8&255,m=h>>16&255,l=h>>24&255;n.setUint32(r,l<<24|c<<16|d<<8|m,!0)}return!0},flipVertical(e,t,i,s){if(t<=0||i<=0||s<=0)return!1;let n=t*s,a=n*i;if(e.length<a)return o.warn("FallbackCodec",`flipVertical: data buffer too small (${e.length} < ${a})`),!1;if(i<=1)return!0;let r=new Uint8Array(n),h=i>>1;for(let c=0;c<h;c++){let d=c*n,m=(i-1-c)*n;r.set(e.subarray(d,d+n)),e.copyWithin(d,m,m+n),e.set(r,m)}return!0},processBitmap(e,t,i,s,n,a){try{if(!n&&(s===16||s===15))return s===16?this.rgb565ToRGBA(e,a):this.rgb555ToRGBA(e,a),this.flipVertical(a,t,i,4),!0;if(!n){switch(s){case 8:this.palette8ToRGBA(e,a);break;case 24:this.bgr24ToRGBA(e,a);break;case 32:this.bgra32ToRGBA(e,a);break;default:return o.warn("FallbackCodec",`Unsupported uncompressed bpp: ${s}`),!1}return this.flipVertical(a,t,i,4),!0}return o.debug("FallbackCodec",`Compressed ${s}bpp not optimized in JS fallback`),!1}catch(r){return o.error("FallbackCodec",`Processing failed: ${r.message}`),!1}}};w.init();var A={initGraphics(){this.canvasShown=!1,this.pointerCache={},this.bitmapCacheEnabled=!0,this.bitmapCache=new Map,this.bitmapCacheMaxSize=1e3,this.bitmapCacheHits=0,this.bitmapCacheMisses=0,this.originalWidth=0,this.originalHeight=0,this.resizeTimeout=null,this.rfxDecoder=new v,this._wasmErrorShown=!1,this._usingFallback=!1,this._fallbackWarningShown=!1,this._capabilitiesLogged=!1,this.handleResize=this.handleResize.bind(this),u.isSupported()||o.debug("Graphics","WebAssembly not available - using JS fallback")},logCapabilities(){if(this._capabilitiesLogged)return;this._capabilitiesLogged=!0;let e=u.isSupported(),t=u.isReady(),i=u.getInitError(),s={wasm:{supported:e,loaded:t,error:i},codecs:{rfx:t,rle:t,nscodec:t,fallback:!t},display:{width:this.originalWidth||window.innerWidth,height:this.originalHeight||window.innerHeight,colorDepth:this.getRecommendedColorDepth(),devicePixelRatio:window.devicePixelRatio||1},browser:{userAgent:navigator.userAgent,platform:navigator.platform}},n=[];return s.codecs.rfx&&n.push("RemoteFX"),s.codecs.rle&&n.push("RLE"),s.codecs.nscodec&&n.push("NSCodec"),s.codecs.fallback&&n.push("JS-Fallback"),console.info("%c[RDP Client] Capabilities","color: #4CAF50; font-weight: bold",`
  WASM:`,t?"\u2713 loaded":e?"\u2717 failed":"\u2717 unsupported",`
  Codecs:`,n.join(", "),`
  Display:`,`${s.display.width}\xD7${s.display.height}`,`
  Color:`,`${s.display.colorDepth}bpp`,i?`
  Error: ${i}`:""),this.emitEvent&&this.emitEvent("capabilities",s),s},getRecommendedColorDepth(){return u.isReady()?32:w.getRecommendedColorDepth()},isUsingFallback(){return this._usingFallback||!u.isReady()},handlePalette(e){let t=e.uint16(!0),i=e.uint16(!0),s=e.uint32(!0);if(s>256||s===0){o.warn("Palette",`Invalid color count: ${s}`);return}o.debug("Palette",`Received ${s} colors`);let n=e.blob(s*3),a=new Uint8Array(n);u.isReady()&&(u.setPalette(a,s),o.debug("Palette","Updated via WASM")),w.setPalette(a,s),o.debug("Palette","Updated in fallback codec")},handleBitmap(e){let t=parseBitmapUpdate(e);this.canvasShown||(this.showCanvas(),this.canvasShown=!0),this.multiMonitorMode&&!this.multiMonitorMessageShown&&(this.showUserSuccess("Multi-monitor environment detected"),this.multiMonitorMessageShown=!0),t.rectangles.forEach(i=>{this.processBitmapData(i)})},processBitmapData(e){let t=e.width,i=e.height,s=e.bitsPerPixel,n=t*i,a=s/8,r=t*a,h=e.isCompressed(),c=new Uint8ClampedArray(n*4),d=new Uint8Array(e.bitmapDataStream);if(u.isReady()){if(u.processBitmap(d,t,i,s,h,c,r)){this.ctx.putImageData(new ImageData(c,t,i),e.destLeft,e.destTop),this.bitmapCacheEnabled&&this.cacheBitmap(e,c);return}o.debug("Bitmap","WASM processBitmap failed, trying fallback")}if(!this._usingFallback){this._usingFallback=!0;let l=u.isReady()?"WASM decode failed":u.getInitError()||"WASM not loaded";o.warn("Bitmap",`Using JavaScript fallback codec (${l})`)}if(w.processBitmap(d,t,i,s,h,c)){this.ctx.putImageData(new ImageData(c,t,i),e.destLeft,e.destTop),this.bitmapCacheEnabled&&this.cacheBitmap(e,c);return}this._wasmErrorShown||(this._wasmErrorShown=!0,o.error("Bitmap",`Cannot decode: bpp=${s}, compressed=${h}`),h&&s!==8&&this.showUserError("Some compressed graphics cannot be displayed. Try reducing color depth."))},initBitmapCache(){this.bitmapCacheEnabled=!0,this.bitmapCache=new Map,this.bitmapCacheMaxSize=1e3,this.bitmapCacheHits=0,this.bitmapCacheMisses=0},cacheBitmap(e,t){let i=this.getBitmapCacheKey(e);if(this.bitmapCache.size>=this.bitmapCacheMaxSize){let s=this.bitmapCache.keys().next().value;this.bitmapCache.delete(s)}this.bitmapCache.set(i,{imageData:new ImageData(new Uint8ClampedArray(t),e.width,e.height),width:e.width,height:e.height,timestamp:Date.now()})},getCachedBitmap(e){let t=this.getBitmapCacheKey(e),i=this.bitmapCache.get(t);return i?(this.bitmapCacheHits++,this.bitmapCache.delete(t),this.bitmapCache.set(t,i),i.imageData):(this.bitmapCacheMisses++,null)},getBitmapCacheKey(e){let t=e.bitmapDataStream.slice(0,Math.min(64,e.bitmapDataStream.length)),i=0;for(let s=0;s<t.length;s++)i=(i<<5)-i+t[s],i=i&i;return`${e.width}x${e.height}x${e.bitsPerPixel}:${i}`},clearBitmapCache(){this.bitmapCache&&this.bitmapCache.clear(),this.bitmapCacheHits=0,this.bitmapCacheMisses=0},getBitmapCacheStats(){return{size:this.bitmapCache?this.bitmapCache.size:0,hits:this.bitmapCacheHits||0,misses:this.bitmapCacheMisses||0,hitRate:this.bitmapCacheHits&&this.bitmapCacheMisses?(this.bitmapCacheHits/(this.bitmapCacheHits+this.bitmapCacheMisses)*100).toFixed(1)+"%":"N/A"}},handlePointer(e,t){try{if(o.debug("Cursor",`Update type: ${e.updateCode}`),e.isPTRNull()){o.debug("Cursor","Hidden"),this.canvas.className="pointer-cache-null";return}if(e.isPTRDefault()){o.debug("Cursor","Default"),this.canvas.className="pointer-cache-default";return}if(e.isPTRColor())return;if(e.isPTRNew()){let i=parseNewPointerUpdate(t);o.debug("Cursor",`New cursor: cache=${i.cacheIndex}, hotspot=(${i.x},${i.y}), size=${i.width}x${i.height}`),this.pointerCacheCanvasCtx.putImageData(i.getImageData(this.pointerCacheCanvasCtx),0,0);let s=this.pointerCacheCanvas.toDataURL("image/png");this.pointerCache.hasOwnProperty(i.cacheIndex)&&(document.getElementsByTagName("head")[0].removeChild(this.pointerCache[i.cacheIndex]),delete this.pointerCache[i.cacheIndex]);let n=document.createElement("style"),a="pointer-cache-"+i.cacheIndex;n.innerHTML="."+a+' {cursor:url("'+s+'") '+i.x+" "+i.y+", auto !important}",document.getElementsByTagName("head")[0].appendChild(n),this.pointerCache[i.cacheIndex]=n,this.canvas.className=a;return}if(e.isPTRCached()){let i=t.uint16(!0);o.debug("Cursor",`Cached index: ${i}`);let s="pointer-cache-"+i;this.canvas.className=s;return}if(e.isPTRPosition()){o.debug("Cursor","Position update (ignored)");return}o.debug("Cursor","Unknown pointer type")}catch(i){o.error("Cursor",`Error: ${i.message}`)}},handleResize(){this.connected&&(this.resizeTimeout&&clearTimeout(this.resizeTimeout),this.resizeTimeout=setTimeout(()=>{let e=window.innerWidth,t=window.innerHeight;(e!==this.originalWidth||t!==this.originalHeight)&&(o.debug("Resize",`${e}x${t}, reconnecting...`),this.showUserInfo("Resizing desktop..."),this.reconnectWithNewSize(e,t))},500))},showCanvas(){o.debug("Connection","First bitmap received - session active");let e=document.getElementById("login-form"),t=document.getElementById("canvas-container");e&&(e.style.display="none"),t&&(t.style.display="block"),this.canvas.tabIndex=1e3,this.canvas.focus()},hideCanvas(){let e=document.getElementById("login-form"),t=document.getElementById("canvas-container");t&&(t.style.display="none"),e&&(e.style.display="block")},clearCanvas(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.canvas.className=""},handleRFXSurface(e){if(!u.isReady()){o.error("RFX","WASM not loaded");return}o.debug("RFX",`Surface command received, ${e.length} bytes`)},setRFXQuant(e,t,i){this.rfxDecoder.setQuant(e,t,i)},decodeRFXTile(e){return this.rfxDecoder.decodeTileToCanvas(e,this.ctx)},processRFXTiles(e){let t=0,i=0;for(let s of e)this.rfxDecoder.decodeTileToCanvas(s,this.ctx)?t++:i++;i>0?o.warn("RFX",`Decoded ${t} tiles, ${i} failed`):o.debug("RFX",`Decoded ${t} tiles`)}};var R={initClipboardSupport(){this.clipboardApiSupported=!!(navigator.clipboard&&navigator.clipboard.writeText),o.debug("Clipboard",`API supported: ${this.clipboardApiSupported}`)},typeTextToRemote(e){if(!this.connected||!e)return;let t=4096;e.length>t&&(e=e.substring(0,t),this.showUserWarning("Text truncated to "+t+" characters")),o.debug("Clipboard",`Typing ${e.length} chars to remote`);let i=0,s=()=>{if(i>=e.length||!this.connected)return;let n=e[i];this.sendCharacter(n),i++,i<e.length&&setTimeout(s,10)};s()},sendCharacter(e){let t=this.charToKeyCode(e);if(!t){o.debug("Clipboard",`No mapping for char code: ${e.charCodeAt(0)}`);return}let i=this.charNeedsShift(e);if(i){let a=new KeyboardEventKeyDown("ShiftLeft");a.keyCode!==void 0&&this.queueInput(a.serialize(),!1)}let s=new KeyboardEventKeyDown(t),n=new KeyboardEventKeyUp(t);if(s.keyCode!==void 0&&(this.queueInput(s.serialize(),!1),this.queueInput(n.serialize(),!1)),i){let a=new KeyboardEventKeyUp("ShiftLeft");a.keyCode!==void 0&&this.queueInput(a.serialize(),!1)}},charNeedsShift(e){return e>="A"&&e<="Z"?!0:'!@#$%^&*()_+{}|:"<>?~'.includes(e)},charToKeyCode(e){let t=e.charCodeAt(0);return t>=65&&t<=90||t>=97&&t<=122?"Key"+e.toUpperCase():t>=48&&t<=57?"Digit"+e:{" ":"Space","\n":"Enter","\r":"Enter","	":"Tab",".":"Period",",":"Comma",";":"Semicolon",":":"Semicolon","'":"Quote",'"':"Quote","/":"Slash","?":"Slash","\\":"Backslash","|":"Backslash","[":"BracketLeft","{":"BracketLeft","]":"BracketRight","}":"BracketRight","-":"Minus",_:"Minus","=":"Equal","+":"Equal","`":"Backquote","~":"Backquote","!":"Digit1","@":"Digit2","#":"Digit3",$:"Digit4","%":"Digit5","^":"Digit6","&":"Digit7","*":"Digit8","(":"Digit9",")":"Digit0","<":"Comma",">":"Period"}[e]||null},async copyToLocalClipboard(e){if(!this.clipboardApiSupported)return!1;try{return await navigator.clipboard.writeText(e),!0}catch(t){return o.warn("Clipboard",`Write failed: ${t.message}`),!1}}};var M={initUI(){this.csrfToken=null},sanitizeInput(e){return e?e.replace(/[<>'"&]/g,"").trim():""},validateHostname(e){return e?/^([a-zA-Z0-9.-]+|(\d{1,3}\.){3}\d{1,3})(:\d{1,5})?$/.test(e)&&e.length<=253:!1},generateCSRFToken(){return crypto.getRandomValues(new Uint8Array(16)).reduce((e,t)=>e+t.toString(16).padStart(2,"0"),"")},showUserError(e){window.showToast&&window.showToast(e,"error","Connection Error",8e3);let t=document.getElementById("status");t&&(t.style.display="block",t.className="status-indicator status-disconnected",t.textContent=e,setTimeout(()=>{t.textContent===e&&(t.style.display="none")},1e4))},showUserSuccess(e){window.showToast&&window.showToast(e,"success","Success",5e3);let t=document.getElementById("status");t&&(t.style.display="block",t.className="status-indicator status-connected",t.textContent=e,setTimeout(()=>{t.textContent===e&&(t.style.display="none")},5e3))},showUserWarning(e){window.showToast&&window.showToast(e,"info","Warning",6e3)},showUserInfo(e){window.showToast&&window.showToast(e,"info","Info",4e3)},logError(e,t){o.error("RDP",`${e}:`,t)},emitEvent(e,t={}){try{document.dispatchEvent(new CustomEvent("rdp:"+e,{detail:t}))}catch(i){o.debug("Event",`Dispatch failed: ${i.message}`)}}};var _={initAudio(){this.audioContext=null,this.audioEnabled=!1,this.audioFormat=null,this.audioQueue=[],this.audioPlaying=!1,this.audioGain=null,this.audioVolume=1,this.audioBufferSize=4096,this.audioSampleRate=44100,this.audioChannels=2,this.audioBitsPerSample=16},enableAudio(){if(!this.audioContext)try{this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.audioGain=this.audioContext.createGain(),this.audioGain.connect(this.audioContext.destination),this.audioGain.gain.value=this.audioVolume,this.audioEnabled=!0,Logger.debug("Audio",`Initialized: ${this.audioContext.sampleRate}Hz`)}catch(e){Logger.error("Audio",`Failed to initialize: ${e.message}`),this.audioEnabled=!1}},disableAudio(){this.audioContext&&(this.audioContext.close(),this.audioContext=null),this.audioEnabled=!1,this.audioQueue=[],Logger.debug("Audio","Disabled")},setAudioVolume(e){this.audioVolume=Math.max(0,Math.min(1,e)),this.audioGain&&(this.audioGain.gain.value=this.audioVolume)},handleAudioMessage(e){if(!this.audioEnabled||!this.audioContext||e.length<4)return;let t=new DataView(e.buffer,e.byteOffset,e.byteLength),i=e[1],s=t.getUint16(2,!0),n=4;if(i===2&&e.length>=12){let r=t.getUint16(4,!0),h=t.getUint32(6,!0),c=t.getUint16(10,!0);if(r<1||r>8){Logger.warn("Audio",`Invalid channel count: ${r}`);return}if(h<8e3||h>192e3){Logger.warn("Audio",`Invalid sample rate: ${h}`);return}if(c!==8&&c!==16){Logger.warn("Audio",`Unsupported bit depth: ${c}`);return}this.audioChannels=r,this.audioSampleRate=h,this.audioBitsPerSample=c,n=12,Logger.debug("Audio",`Format: ${this.audioSampleRate}Hz ${this.audioChannels}ch ${this.audioBitsPerSample}bit`)}let a=e.slice(n);a.length!==0&&this.queueAudio(a,s)},queueAudio(e,t){let i=this.pcmToFloat32(e);if(!i||i.length===0)return;let s=Math.floor(i.length/this.audioChannels);if(s!==0)try{let n=this.audioContext.createBuffer(this.audioChannels,s,this.audioSampleRate);for(let a=0;a<this.audioChannels;a++){let r=n.getChannelData(a);for(let h=0;h<s;h++)r[h]=i[h*this.audioChannels+a]}this.audioQueue.push({buffer:n,timestamp:t}),this.audioPlaying||this.playNextAudio()}catch(n){Logger.error("Audio",`Buffer creation failed: ${n.message}`)}},pcmToFloat32(e){let t=new DataView(e.buffer,e.byteOffset,e.byteLength),i=[];if(this.audioBitsPerSample===16){let s=Math.floor(e.length/2);for(let n=0;n<s;n++){let a=t.getInt16(n*2,!0);i.push(a/32768)}}else if(this.audioBitsPerSample===8)for(let s=0;s<e.length;s++){let n=e[s];i.push((n-128)/128)}else return Logger.warn("Audio",`Unsupported bit depth: ${this.audioBitsPerSample}`),null;return i},playNextAudio(){if(this.audioQueue.length===0){this.audioPlaying=!1;return}this.audioPlaying=!0;let e=this.audioQueue.shift(),t=this.audioContext.createBufferSource();t.buffer=e.buffer,t.connect(this.audioGain),t.onended=()=>{this.playNextAudio()};let i=this.audioContext.currentTime;t.start(i)},resumeAudioContext(){this.audioContext&&this.audioContext.state==="suspended"&&this.audioContext.resume().then(()=>{Logger.debug("Audio","Context resumed")})}},k=_;function y(e){Object.keys(e).forEach(t=>{typeof e[t]=="function"&&(g.prototype[t]=e[t])})}function g(e,t,i,s,n){this.websocketURL=e,this.canvas=document.getElementById(t),this.hostEl=document.getElementById(i),this.userEl=document.getElementById(s),this.passwordEl=document.getElementById(n),this.ctx=this.canvas.getContext("2d"),this.pointerCacheCanvas=document.getElementById("pointer-cache"),this.pointerCacheCanvasCtx=this.pointerCacheCanvas.getContext("2d"),this.connected=!1,this.socket=null,this.initSession(),this.initInput(),this.initGraphics(),this.initUI(),this.initAudio(),this.initialize=this.initialize.bind(this),this.handleMessage=this.handleMessage.bind(this),this.deinitialize=this.deinitialize.bind(this),this.loadSession(),this.shouldAutoReconnect()&&this.scheduleReconnect(100)}y(x);y(S);y(A);y(R);y(M);y(k);g.prototype.connect=function(){if(this.socket&&this.socket.readyState===WebSocket.OPEN){o.warn("Connection","Already established");return}let e=this.sanitizeInput(this.hostEl.value),t=this.sanitizeInput(this.userEl.value),i=this.passwordEl.value;if(!this.validateHostname(e)){o.error("Connection","Invalid hostname format");return}this.reconnectAttempts=0,this.manualDisconnect=!1,this.lastConnectionTime=Date.now(),this.csrfToken=this.generateCSRFToken();let s=window.innerWidth,n=window.innerHeight;this.originalWidth=s,this.originalHeight=n,this.canvas.width=s,this.canvas.height=n;let a=document.getElementById("colorDepth"),r=a?a.value:"16",h=document.getElementById("disableNLA"),c=h?h.checked:!1;o.debug("Connection",`Connecting to ${e} as ${t} (${s}x${n}, ${r}bpp)`);let d=new URL(this.websocketURL);d.searchParams.set("width",s),d.searchParams.set("height",n),d.searchParams.set("colorDepth",r),c&&(d.searchParams.set("disableNLA","true"),o.debug("Connection","NLA disabled")),d.searchParams.set("audio","true"),this.enableAudio(),o.debug("Audio","Audio redirection enabled"),this._pendingCredentials={host:e,user:t,password:i},this.socket=new WebSocket(d.toString());let m=this._pendingCredentials;this.socket.onopen=()=>{if(o.debug("Connection","WebSocket opened, sending credentials"),m){let l=JSON.stringify({type:"credentials",host:m.host,user:m.user,password:m.password});this.socket.send(l),this._pendingCredentials=null}this.initialize()},this.socket.onmessage=l=>{l.data.arrayBuffer().then(f=>this.handleMessage(f)).catch(f=>o.error("Message",`Failed to read message: ${f.message}`))},this.socket.onerror=l=>{let f=l.message||"";this.logError("WebSocket connection error",{error:f,code:l.code}),f.includes("401")||f.includes("Unauthorized")?this.showUserError("Authentication failed: Invalid username or password"):f.includes("403")||f.includes("Forbidden")?this.showUserError("Access denied: You do not have permission to connect"):f.includes("404")||f.includes("Not Found")?this.showUserError("Server not found: Check the server address"):f.includes("timeout")?this.showUserError("Connection timeout: Server is not responding"):this.showUserError("Connection failed: Unable to connect to server"),this.emitEvent("error",{message:f,code:l.code})},this.socket.onclose=l=>{if(o.debug("Connection",`WebSocket closed (code=${l.code}, reason=${l.reason||"none"})`),this.emitEvent("disconnected",{code:l.code,reason:l.reason,wasClean:l.wasClean,manual:this.manualDisconnect}),this.manualDisconnect){this.showUserSuccess("Disconnected successfully");return}if(l.code!==1e3){if(l.code===1001?this.showUserError("Connection closed: Going away"):l.code===1002?this.showUserError("Connection closed: Protocol error"):l.code===1003?this.showUserError("Connection closed: Unsupported data type"):l.code===1006?this.showUserError("Connection closed abnormally: Check your network connection"):l.code===1015?this.showUserError("TLS handshake failed: Certificate validation error"):this.showUserError(`Connection lost (code: ${l.code})`),!this.manualDisconnect&&this.reconnectAttempts<this.maxReconnectAttempts){let f=Math.max(0,this.reconnectAttempts-1),L=this.reconnectDelay*Math.pow(2,f);this.scheduleReconnect(Math.min(L,3e4))}this.deinitialize()}},this.saveSession()};g.prototype.sendAuthentication=function(){if(!this.socket||this.socket.readyState!==WebSocket.OPEN){this.showUserError("Connection lost during authentication");return}try{let e={type:"auth",user:this.sanitizeInput(this.userEl.value),password:this.passwordEl.value,host:this.sanitizeInput(this.hostEl.value),sessionId:this.sessionId,csrfToken:this.csrfToken,timestamp:Date.now()};this.socket.send(JSON.stringify(e)),o.debug("Connection","Authentication data sent")}catch(e){this.showUserError("Failed to send authentication data"),o.error("Connection","Authentication send error:",e)}};g.prototype.initialize=function(){this.connected||(this.reconnectAttempts=0,this.lastConnectionTime=Date.now(),window.addEventListener("keydown",this.handleKeyDown),window.addEventListener("keyup",this.handleKeyUp),this.canvas.addEventListener("mousemove",this.handleMouseMove),this.canvas.addEventListener("mousedown",this.handleMouseDown),this.canvas.addEventListener("mouseup",this.handleMouseUp),this.canvas.addEventListener("contextmenu",this.handleMouseUp),this.canvas.addEventListener("click",()=>{this.canvas.focus(),this.resumeAudioContext()}),this.canvas.addEventListener("wheel",this.handleWheel),this.canvas.addEventListener("touchstart",this.handleTouchStart,{passive:!1}),this.canvas.addEventListener("touchmove",this.handleTouchMove,{passive:!1}),this.canvas.addEventListener("touchend",this.handleTouchEnd,{passive:!1}),window.addEventListener("resize",this.handleResize),this.connected=!0,this.logCapabilities())};g.prototype.showCanvas=function(){let e=document.getElementById("canvas-container"),t=document.querySelector(".container");t&&(t.style.display="none"),e&&(e.style.cssText="display: block !important; position: fixed !important; top: 0 !important; left: 0 !important; width: 100vw !important; height: 100vh !important; z-index: 9999 !important; background: #000 !important;",e.offsetHeight),this.canvas.style.cssText="display: block !important; visibility: visible !important; opacity: 1 !important; position: absolute !important; top: 0 !important; left: 0 !important; width: "+this.canvas.width+"px !important; height: "+this.canvas.height+"px !important;",this.canvas.setAttribute("tabindex","0"),this.canvas.style.outline="none",this.canvas.focus(),this.canvas.offsetHeight,this.initBitmapCache(),this.initClipboardSupport(),this.startTimeoutTracking(),this.emitEvent("connected",{host:this.sanitizeInput(this.hostEl.value),user:this.sanitizeInput(this.userEl.value)})};g.prototype.deinitialize=function(){this.connected=!1,this.canvasShown=!1,window.removeEventListener("keydown",this.handleKeyDown),window.removeEventListener("keyup",this.handleKeyUp),this.canvas.removeEventListener("mousemove",this.handleMouseMove),this.canvas.removeEventListener("mousedown",this.handleMouseDown),this.canvas.removeEventListener("mouseup",this.handleMouseUp),this.canvas.removeEventListener("contextmenu",this.handleMouseUp),this.canvas.removeEventListener("wheel",this.handleWheel),this.canvas.removeEventListener("touchstart",this.handleTouchStart),this.canvas.removeEventListener("touchmove",this.handleTouchMove),this.canvas.removeEventListener("touchend",this.handleTouchEnd),window.removeEventListener("resize",this.handleResize),this.clearAllTimeouts(),this.clearBitmapCache(),this.disableAudio(),Object.entries(this.pointerCache).forEach(([e,t])=>{try{t&&t.parentNode&&t.parentNode.removeChild(t)}catch{}}),this.pointerCache={},this.canvas.classList=[],this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)};g.prototype.handleMessage=function(e){if(!this.connected)return;let t=new Uint8Array(e)[0];if(t===254&&this.audioEnabled){this.handleAudioMessage(new Uint8Array(e));return}if(t===255){if(e.byteLength>1024*1024){o.warn("Message","JSON message too large, ignoring");return}try{let n=e.slice(1),a=new TextDecoder().decode(n),r=JSON.parse(a);r.type==="capabilities"?(r.logLevel&&o.setLevel(r.logLevel),o.debug("Capabilities",`Server: codecs=${r.codecs?.join(",")||"none"}, colorDepth=${r.colorDepth}, desktop=${r.desktopSize}`),this.serverCapabilities=r):r.type==="error"&&(this.showUserError(r.message),this.emitEvent("error",{message:r.message}));return}catch(n){o.warn("Message",`Failed to parse 0xFF message: ${n.message}`)}}if(e.byteLength>1024*1024){this.handleBitmapUpdate(new Uint8Array(e));return}try{let n=new TextDecoder().decode(e),a=JSON.parse(n);if(a.type==="clipboard_response"){o.debug("Clipboard","Received remote clipboard data"),this.handleRemoteClipboard(a.data);return}if(a.type==="file_transfer_status"){this.updateFileStatus(a.message);return}if(a.type==="error"){this.showUserError(a.message),this.emitEvent("error",{message:a.message});return}}catch{}let i=new BinaryReader(e),s=parseUpdateHeader(i);if(o.debug("Update",`code=${s.updateCode}, pointer=${s.isPointer()}`),s.isCompressed()){o.warn("Update","Compression not supported");return}if(s.isBitmap()){this.handleBitmap(i);return}if(s.isPointer()){this.handlePointer(s,i);return}if(s.isSynchronize()){o.debug("Update","Synchronize received");return}if(s.isPalette()){this.handlePalette(i);return}s.updateCode!==15&&o.debug("Update",`Unknown update code: ${s.updateCode}`)};g.prototype.disconnect=function(){this.socket&&(this.manualDisconnect=!0,this.clearSession(),this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=null),this.deinitialize(),this.socket.close(1e3))};g.prototype.reconnectWithNewSize=function(e,t){this.originalWidth=e,this.originalHeight=t,this.socket&&(this.manualDisconnect=!0,this.socket.close(1e3)),setTimeout(()=>{this.manualDisconnect=!1,this.connect()},500)};var N={_storageKey:"rdp_connection_history",_maxHistory:5,_normalizeHost(e){return e&&e.replace(/:3389$/,"")},save(e,t){if(!e||!t)return;e=this._normalizeHost(e);let i=this.get(),s={host:e,username:t,timestamp:Date.now()},n=i.filter(r=>!(this._normalizeHost(r.host)===e&&r.username===t));n.unshift(s);let a=n.slice(0,this._maxHistory);try{localStorage.setItem(this._storageKey,JSON.stringify(a)),Logger.debug("[ConnectionHistory] Saved connection:",e,t)}catch(r){console.error("[ConnectionHistory] Failed to save:",r)}},get(){try{let e=localStorage.getItem(this._storageKey);if(!e)return[];let t=JSON.parse(e);return Array.isArray(t)?t:[]}catch(e){return console.error("[ConnectionHistory] Failed to load:",e),[]}},clear(){try{localStorage.removeItem(this._storageKey),Logger.info("[ConnectionHistory] History cleared")}catch(e){console.error("[ConnectionHistory] Failed to clear:",e)}},remove(e,t){let s=this.get().filter(n=>!(this._normalizeHost(n.host)===this._normalizeHost(e)&&n.username===t));try{localStorage.setItem(this._storageKey,JSON.stringify(s)),Logger.debug("[ConnectionHistory] Removed connection:",e,t)}catch(n){console.error("[ConnectionHistory] Failed to remove:",n)}}},E=N;typeof window<"u"&&(window.Client=g,window.Logger=o,window.WASMCodec=u,window.RFXDecoder=v,window.FallbackCodec=w,window.isWASMSupported=b,window.ConnectionHistory=E);var P=g;return $(H);})();
