var RDP=(()=>{var g=Object.defineProperty;var S=Object.getOwnPropertyDescriptor;var k=Object.getOwnPropertyNames;var U=Object.prototype.hasOwnProperty;var L=(e,t)=>{for(var i in t)g(e,i,{get:t[i],enumerable:!0})},D=(e,t,i,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of k(t))!U.call(e,o)&&o!==i&&g(e,o,{get:()=>t[o],enumerable:!(s=S(t,o))||s.enumerable});return e};var A=e=>D(g({},"__esModule",{value:!0}),e);var z={};L(z,{Client:()=>u,Logger:()=>n,default:()=>P});var h={DEBUG:0,INFO:1,WARN:2,ERROR:3,NONE:4},n={level:h.INFO,setLevel(e){let t={debug:h.DEBUG,info:h.INFO,warn:h.WARN,warning:h.WARN,error:h.ERROR,none:h.NONE};this.level=t[e.toLowerCase()]??h.INFO},debug(e,...t){this.level<=h.DEBUG&&console.log(`[${e}]`,...t)},info(e,...t){this.level<=h.INFO&&console.info(`[${e}]`,...t)},warn(e,...t){this.level<=h.WARN&&console.warn(`[${e}]`,...t)},error(e,...t){this.level<=h.ERROR&&console.error(`[${e}]`,...t)},enableDebug(){this.level=h.DEBUG},quiet(){this.level=h.ERROR}};function I(){return"session_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}var y={initSession(){this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.reconnectDelay=2e3,this.reconnectTimeout=null,this.lastConnectionTime=null,this.manualDisconnect=!1,this.sessionId=I(),this.maxSessionTime=8*60*60*1e3,this.maxIdleTime=30*60*1e3,this.lastActivityTime=null,this.sessionTimeout=null,this.idleTimeout=null,this.warningTimeout=null,this.warningShown=!1,this.loadSession()},shouldAutoReconnect(){return!1},saveSession(){try{let e=new Date(Date.now()+2592e6).toUTCString();document.cookie=`rdp_host=${encodeURIComponent(this.hostEl.value)}; expires=${e}; path=/; SameSite=Strict`,document.cookie=`rdp_user=${encodeURIComponent(this.userEl.value)}; expires=${e}; path=/; SameSite=Strict`}catch(e){n.warn("Session",`Failed to save: ${e.message}`)}},loadSession(){try{let e=document.cookie.split(";").reduce((t,i)=>{let[s,o]=i.trim().split("=");return s&&o&&(t[s]=decodeURIComponent(o)),t},{});e.rdp_host&&(this.hostEl.value=e.rdp_host),e.rdp_user&&(this.userEl.value=e.rdp_user)}catch(e){n.debug("Session",`Failed to load: ${e.message}`)}},verifySessionIntegrity(e){return["host","user","timestamp","sessionId"].every(i=>e.hasOwnProperty(i))},clearSession(){document.cookie="rdp_host=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;",document.cookie="rdp_user=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;",this.manualDisconnect=!0},scheduleReconnect(e){this.reconnectTimeout&&clearTimeout(this.reconnectTimeout),!(this.reconnectAttempts>=this.maxReconnectAttempts||this.manualDisconnect)&&(this.reconnectTimeout=setTimeout(()=>{this.shouldAutoReconnect()&&!this.connected&&(n.info("Session",`Reconnect attempt ${this.reconnectAttempts+1}/${this.maxReconnectAttempts}`),this.attemptReconnect())},e))},attemptReconnect(){if(!this.hostEl.value||!this.userEl.value)return;this.reconnectAttempts++;let e=new URL(this.websocketURL);e.searchParams.set("host",this.hostEl.value),e.searchParams.set("user",this.userEl.value),e.searchParams.set("password",this.passwordEl.value||""),e.searchParams.set("width",this.canvas.width),e.searchParams.set("height",this.canvas.height),e.searchParams.set("sessionId",this.sessionId),this.socket=new WebSocket(e.toString()),this.socket.onopen=this.initialize,this.socket.onmessage=t=>{t.data.arrayBuffer().then(i=>this.handleMessage(i))},this.socket.onerror=t=>{n.warn("Session","Reconnection error")},this.socket.onclose=t=>{if(!this.manualDisconnect&&this.reconnectAttempts<this.maxReconnectAttempts){let i=this.reconnectDelay*Math.pow(2,this.reconnectAttempts-1);this.scheduleReconnect(Math.min(i,3e4))}}},startTimeoutTracking(){this.lastConnectionTime=Date.now(),this.lastActivityTime=Date.now(),this.sessionTimeout=setTimeout(()=>{this.handleSessionTimeout()},this.maxSessionTime),this.resetIdleTimeout()},updateActivity(){this.lastActivityTime=Date.now(),this.warningShown=!1;let e=document.getElementById("idle-warning");e&&(e.style.display="none"),this.resetIdleTimeout()},resetIdleTimeout(){this.idleTimeout&&clearTimeout(this.idleTimeout),this.warningTimeout&&clearTimeout(this.warningTimeout),this.warningTimeout=setTimeout(()=>{this.showIdleWarning()},this.maxIdleTime-5*60*1e3),this.idleTimeout=setTimeout(()=>{this.handleIdleTimeout()},this.maxIdleTime)},showIdleWarning(){if(this.warningShown)return;this.warningShown=!0;let e=document.getElementById("idle-warning");e||(e=document.createElement("div"),e.id="idle-warning",e.className="idle-warning",e.innerHTML="Session will disconnect in 5 minutes due to inactivity. Move mouse or press a key to stay connected.",document.body.appendChild(e)),e.style.display="block"},handleIdleTimeout(){n.info("Session","Disconnected due to inactivity"),this.showUserWarning("Session disconnected due to inactivity"),this.disconnect()},handleSessionTimeout(){n.info("Session","Maximum session time reached (8 hours)"),this.showUserWarning("Session disconnected - maximum session time reached (8 hours)"),this.disconnect()},clearAllTimeouts(){this.sessionTimeout&&(clearTimeout(this.sessionTimeout),this.sessionTimeout=null),this.idleTimeout&&(clearTimeout(this.idleTimeout),this.idleTimeout=null),this.warningTimeout&&(clearTimeout(this.warningTimeout),this.warningTimeout=null),this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=null)}};function R(e){let t=0,i=0;for(;e&&!isNaN(e.offsetLeft)&&!isNaN(e.offsetTop);)t+=e.offsetLeft-e.scrollLeft,i+=e.offsetTop-e.scrollTop,e=e.offsetParent;return{top:i,left:t}}function C(e){switch(e){case 0:return 1;case 1:return 3;case 2:return 2;default:return 1}}var E={initInput(){this.isDragging=!1,this.inputQueue=[],this.inputFlushPending=!1,this.lastMouseMove=null,this.mouseThrottleMs=16,this.lastMouseSendTime=0,this.lastActivityUpdate=null,this.lastTouchUpdate=null,this.handleKeyDown=this.handleKeyDown.bind(this),this.handleKeyUp=this.handleKeyUp.bind(this),this.handleMouseMove=this.handleMouseMove.bind(this),this.handleMouseDown=this.handleMouseDown.bind(this),this.handleMouseUp=this.handleMouseUp.bind(this),this.handleWheel=this.handleWheel.bind(this),this.handleTouchStart=this.handleTouchStart.bind(this),this.handleTouchMove=this.handleTouchMove.bind(this),this.handleTouchEnd=this.handleTouchEnd.bind(this)},screenToDesktop(e,t){let i=R(this.canvas),s=Math.floor(e-i.left),o=Math.floor(t-i.top);return{x:s,y:o}},queueInput(e,t){t?this.lastMouseMove=e:this.inputQueue.push(e),this.inputFlushPending||(this.inputFlushPending=!0,setTimeout(()=>this.flushInputQueue(),0))},flushInputQueue(){if(this.inputFlushPending=!1,!this.connected||!this.socket||this.socket.readyState!==WebSocket.OPEN){this.inputQueue=[],this.lastMouseMove=null;return}for(;this.inputQueue.length>0;){let t=this.inputQueue.shift();try{this.socket.send(t)}catch{this.inputQueue=[];break}}let e=Date.now();if(this.lastMouseMove&&e-this.lastMouseSendTime>=this.mouseThrottleMs){try{this.socket.send(this.lastMouseMove),this.lastMouseSendTime=e}catch{}this.lastMouseMove=null}else this.lastMouseMove&&(this.inputFlushPending||(this.inputFlushPending=!0,setTimeout(()=>this.flushInputQueue(),this.mouseThrottleMs)))},handleKeyDown(e){if(!this.connected){this.showUserError("Cannot send keystrokes: not connected to server");return}this.updateActivity();let t=new KeyboardEventKeyDown(e.code);if(t.keyCode===void 0)return this.logError("Key mapping error",{code:e.code,key:e.key}),this.showUserError("Unsupported key: "+e.key),e.preventDefault(),!1;try{let i=t.serialize();this.queueInput(i,!1)}catch(i){this.logError("Key send error",{code:e.code,error:i.message}),this.showUserError("Failed to send keystroke")}return e.preventDefault(),!1},handleKeyUp(e){if(!this.connected)return;this.updateActivity();let t=new KeyboardEventKeyUp(e.code);if(t.keyCode===void 0)return n.debug("[Input] Undefined key up:",e.code),e.preventDefault(),!1;let i=t.serialize();return this.queueInput(i,!1),e.preventDefault(),!1},handleMouseMove(e){(!this.lastActivityUpdate||Date.now()-this.lastActivityUpdate>1e3)&&(this.updateActivity(),this.lastActivityUpdate=Date.now());try{let t=this.screenToDesktop(e.clientX,e.clientY),s=new MouseMoveEvent(t.x,t.y).serialize();this.queueInput(s,!0)}catch(t){this.logError("Mouse move error",{x:e.clientX,y:e.clientY,error:t.message})}return e.preventDefault(),!1},handleMouseDown(e){this.updateActivity(),this.isDragging=!0;let t=this.screenToDesktop(e.clientX,e.clientY),s=new MouseDownEvent(t.x,t.y,C(e.button)).serialize();return this.queueInput(s,!1),document.addEventListener("mousemove",this.handleMouseMove),document.addEventListener("mouseup",this.handleMouseUp),e.preventDefault(),!1},handleMouseUp(e){this.isDragging=!1;let t=this.screenToDesktop(e.clientX,e.clientY),s=new MouseUpEvent(t.x,t.y,C(e.button)).serialize();return this.queueInput(s,!1),document.removeEventListener("mousemove",this.handleMouseMove),document.removeEventListener("mouseup",this.handleMouseUp),e.preventDefault(),!1},handleWheel(e){this.updateActivity();let t=this.screenToDesktop(e.clientX,e.clientY),i=Math.abs(e.deltaX)>Math.abs(e.deltaY),s=i?e.deltaX:e.deltaY,o=Math.round(Math.abs(s)*15/8),l=new MouseWheelEvent(t.x,t.y,o,s>0,i).serialize();return this.queueInput(l,!1),e.preventDefault(),!1},handleTouchStart(e){if(!this.connected)return;e.preventDefault(),this.updateActivity();let t=e.touches[0],i={clientX:t.clientX,clientY:t.clientY,button:0,preventDefault:()=>{}};return this.handleMouseDown(i)},handleTouchMove(e){if(this.connected&&(e.preventDefault(),!this.lastTouchUpdate||Date.now()-this.lastTouchUpdate>16)){this.updateActivity(),this.lastTouchUpdate=Date.now();let t=e.touches[0],i={clientX:t.clientX,clientY:t.clientY,preventDefault:()=>{}};return this.handleMouseMove(i)}},handleTouchEnd(e){if(!this.connected)return;e.preventDefault(),this.updateActivity();let t=e.changedTouches[0],i={clientX:t.clientX,clientY:t.clientY,button:0,preventDefault:()=>{}};return this.handleMouseUp(i)},attachInputListeners(){this.canvas.addEventListener("keydown",this.handleKeyDown,!1),this.canvas.addEventListener("keyup",this.handleKeyUp,!1),this.canvas.addEventListener("mousemove",this.handleMouseMove,!1),this.canvas.addEventListener("mousedown",this.handleMouseDown,!1),this.canvas.addEventListener("mouseup",this.handleMouseUp,!1),this.canvas.addEventListener("wheel",this.handleWheel,!1),this.canvas.addEventListener("contextmenu",e=>(e.preventDefault(),!1)),this.canvas.addEventListener("touchstart",this.handleTouchStart,{passive:!1}),this.canvas.addEventListener("touchmove",this.handleTouchMove,{passive:!1}),this.canvas.addEventListener("touchend",this.handleTouchEnd,{passive:!1})},detachInputListeners(){this.canvas.removeEventListener("keydown",this.handleKeyDown),this.canvas.removeEventListener("keyup",this.handleKeyUp),this.canvas.removeEventListener("mousemove",this.handleMouseMove),this.canvas.removeEventListener("mousedown",this.handleMouseDown),this.canvas.removeEventListener("mouseup",this.handleMouseUp),this.canvas.removeEventListener("wheel",this.handleWheel),this.canvas.removeEventListener("touchstart",this.handleTouchStart),this.canvas.removeEventListener("touchmove",this.handleTouchMove),this.canvas.removeEventListener("touchend",this.handleTouchEnd),document.removeEventListener("mousemove",this.handleMouseMove),document.removeEventListener("mouseup",this.handleMouseUp)}};var b={initGraphics(){this.canvasShown=!1,this.pointerCache={},this.bitmapCacheEnabled=!0,this.bitmapCache=new Map,this.bitmapCacheMaxSize=1e3,this.bitmapCacheHits=0,this.bitmapCacheMisses=0,this.originalWidth=0,this.originalHeight=0,this.resizeTimeout=null,this.handleResize=this.handleResize.bind(this)},handlePalette(e){let t=e.uint16(!0),i=e.uint16(!0),s=e.uint32(!0);if(s>256||s===0){n.warn("Palette",`Invalid color count: ${s}`);return}n.info("Palette",`Received ${s} colors`);let o=e.blob(s*3);typeof goRLE<"u"&&goRLE.setPalette?(goRLE.setPalette(new Uint8Array(o),s),n.debug("Palette","Updated via WASM")):n.warn("Palette","WASM not available")},handleBitmap(e){let t=parseBitmapUpdate(e);this.canvasShown||(this.showCanvas(),this.canvasShown=!0),this.multiMonitorMode&&!this.multiMonitorMessageShown&&(this.showUserSuccess("Multi-monitor environment detected"),this.multiMonitorMessageShown=!0),t.rectangles.forEach(i=>{this.processBitmapData(i)})},processBitmapData(e){let t=e.width,i=e.height,s=e.bitsPerPixel,o=t*i,a=s/8,l=t*a,d=e.isCompressed(),f=new Uint8ClampedArray(o*4);if(typeof goRLE<"u"&&goRLE.processBitmap){let v=new Uint8Array(e.bitmapDataStream);if(goRLE.processBitmap(v,t,i,s,d,f,l)){this.ctx.putImageData(new ImageData(f,t,i),e.destLeft,e.destTop),this.bitmapCacheEnabled&&this.cacheBitmap(e,f);return}n.debug("Bitmap",`WASM processBitmap failed, bpp=${s}, compressed=${d}`)}else n.error("Bitmap","WASM not loaded")},initBitmapCache(){this.bitmapCacheEnabled=!0,this.bitmapCache=new Map,this.bitmapCacheMaxSize=1e3,this.bitmapCacheHits=0,this.bitmapCacheMisses=0},cacheBitmap(e,t){let i=this.getBitmapCacheKey(e);if(this.bitmapCache.size>=this.bitmapCacheMaxSize){let s=this.bitmapCache.keys().next().value;this.bitmapCache.delete(s)}this.bitmapCache.set(i,{imageData:new ImageData(new Uint8ClampedArray(t),e.width,e.height),width:e.width,height:e.height,timestamp:Date.now()})},getCachedBitmap(e){let t=this.getBitmapCacheKey(e),i=this.bitmapCache.get(t);return i?(this.bitmapCacheHits++,this.bitmapCache.delete(t),this.bitmapCache.set(t,i),i.imageData):(this.bitmapCacheMisses++,null)},getBitmapCacheKey(e){let t=e.bitmapDataStream.slice(0,Math.min(64,e.bitmapDataStream.length)),i=0;for(let s=0;s<t.length;s++)i=(i<<5)-i+t[s],i=i&i;return`${e.width}x${e.height}x${e.bitsPerPixel}:${i}`},clearBitmapCache(){this.bitmapCache&&this.bitmapCache.clear(),this.bitmapCacheHits=0,this.bitmapCacheMisses=0},getBitmapCacheStats(){return{size:this.bitmapCache?this.bitmapCache.size:0,hits:this.bitmapCacheHits||0,misses:this.bitmapCacheMisses||0,hitRate:this.bitmapCacheHits&&this.bitmapCacheMisses?(this.bitmapCacheHits/(this.bitmapCacheHits+this.bitmapCacheMisses)*100).toFixed(1)+"%":"N/A"}},handlePointer(e,t){try{if(n.debug("Cursor",`Update type: ${e.updateCode}`),e.isPTRNull()){n.debug("Cursor","Hidden"),this.canvas.className="pointer-cache-null";return}if(e.isPTRDefault()){n.debug("Cursor","Default"),this.canvas.className="pointer-cache-default";return}if(e.isPTRColor())return;if(e.isPTRNew()){let i=parseNewPointerUpdate(t);n.debug("Cursor",`New cursor: cache=${i.cacheIndex}, hotspot=(${i.x},${i.y}), size=${i.width}x${i.height}`),this.pointerCacheCanvasCtx.putImageData(i.getImageData(this.pointerCacheCanvasCtx),0,0);let s=this.pointerCacheCanvas.toDataURL("image/png");this.pointerCache.hasOwnProperty(i.cacheIndex)&&(document.getElementsByTagName("head")[0].removeChild(this.pointerCache[i.cacheIndex]),delete this.pointerCache[i.cacheIndex]);let o=document.createElement("style"),a="pointer-cache-"+i.cacheIndex;o.innerHTML="."+a+' {cursor:url("'+s+'") '+i.x+" "+i.y+", auto !important}",document.getElementsByTagName("head")[0].appendChild(o),this.pointerCache[i.cacheIndex]=o,this.canvas.className=a;return}if(e.isPTRCached()){let i=t.uint16(!0);n.debug("Cursor",`Cached index: ${i}`);let s="pointer-cache-"+i;this.canvas.className=s;return}if(e.isPTRPosition()){n.debug("Cursor","Position update (ignored)");return}n.debug("Cursor","Unknown pointer type")}catch(i){n.error("Cursor",`Error: ${i.message}`)}},handleResize(){this.connected&&(this.resizeTimeout&&clearTimeout(this.resizeTimeout),this.resizeTimeout=setTimeout(()=>{let e=window.innerWidth,t=window.innerHeight;(e!==this.originalWidth||t!==this.originalHeight)&&(n.info("Resize",`${e}x${t}, reconnecting...`),this.showUserInfo("Resizing desktop..."),this.reconnectWithNewSize(e,t))},500))},showCanvas(){n.info("Connection","First bitmap received - session active");let e=document.getElementById("login-form"),t=document.getElementById("canvas-container");e&&(e.style.display="none"),t&&(t.style.display="block"),this.canvas.tabIndex=1e3,this.canvas.focus()},hideCanvas(){let e=document.getElementById("login-form"),t=document.getElementById("canvas-container");t&&(t.style.display="none"),e&&(e.style.display="block")},clearCanvas(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.canvas.className=""}};var T={initClipboardSupport(){this.clipboardApiSupported=!!(navigator.clipboard&&navigator.clipboard.writeText),n.info("Clipboard",`API supported: ${this.clipboardApiSupported}`)},typeTextToRemote(e){if(!this.connected||!e)return;let t=4096;e.length>t&&(e=e.substring(0,t),this.showUserWarning("Text truncated to "+t+" characters")),n.info("Clipboard",`Typing ${e.length} chars to remote`);let i=0,s=()=>{if(i>=e.length||!this.connected)return;let o=e[i];this.sendCharacter(o),i++,i<e.length&&setTimeout(s,10)};s()},sendCharacter(e){let t=this.charToKeyCode(e);if(!t){n.debug("Clipboard",`No mapping for char code: ${e.charCodeAt(0)}`);return}let i=this.charNeedsShift(e);if(i){let a=new KeyboardEventKeyDown("ShiftLeft");a.keyCode!==void 0&&this.queueInput(a.serialize(),!1)}let s=new KeyboardEventKeyDown(t),o=new KeyboardEventKeyUp(t);if(s.keyCode!==void 0&&(this.queueInput(s.serialize(),!1),this.queueInput(o.serialize(),!1)),i){let a=new KeyboardEventKeyUp("ShiftLeft");a.keyCode!==void 0&&this.queueInput(a.serialize(),!1)}},charNeedsShift(e){return e>="A"&&e<="Z"?!0:'!@#$%^&*()_+{}|:"<>?~'.includes(e)},charToKeyCode(e){let t=e.charCodeAt(0);return t>=65&&t<=90||t>=97&&t<=122?"Key"+e.toUpperCase():t>=48&&t<=57?"Digit"+e:{" ":"Space","\n":"Enter","\r":"Enter","	":"Tab",".":"Period",",":"Comma",";":"Semicolon",":":"Semicolon","'":"Quote",'"':"Quote","/":"Slash","?":"Slash","\\":"Backslash","|":"Backslash","[":"BracketLeft","{":"BracketLeft","]":"BracketRight","}":"BracketRight","-":"Minus",_:"Minus","=":"Equal","+":"Equal","`":"Backquote","~":"Backquote","!":"Digit1","@":"Digit2","#":"Digit3",$:"Digit4","%":"Digit5","^":"Digit6","&":"Digit7","*":"Digit8","(":"Digit9",")":"Digit0","<":"Comma",">":"Period"}[e]||null},async copyToLocalClipboard(e){if(!this.clipboardApiSupported)return!1;try{return await navigator.clipboard.writeText(e),!0}catch(t){return n.warn("Clipboard",`Write failed: ${t.message}`),!1}}};var M={initUI(){this.csrfToken=null},sanitizeInput(e){return e?e.replace(/[<>'"&]/g,"").trim():""},validateHostname(e){return e?/^([a-zA-Z0-9.-]+|(\d{1,3}\.){3}\d{1,3})(:\d{1,5})?$/.test(e)&&e.length<=253:!1},generateCSRFToken(){return crypto.getRandomValues(new Uint8Array(16)).reduce((e,t)=>e+t.toString(16).padStart(2,"0"),"")},showUserError(e){window.showToast&&window.showToast(e,"error","Connection Error",8e3);let t=document.getElementById("status");t&&(t.style.display="block",t.className="status-indicator status-disconnected",t.textContent=e,setTimeout(()=>{t.textContent===e&&(t.style.display="none")},1e4))},showUserSuccess(e){window.showToast&&window.showToast(e,"success","Success",5e3);let t=document.getElementById("status");t&&(t.style.display="block",t.className="status-indicator status-connected",t.textContent=e,setTimeout(()=>{t.textContent===e&&(t.style.display="none")},5e3))},showUserWarning(e){window.showToast&&window.showToast(e,"info","Warning",6e3)},showUserInfo(e){window.showToast&&window.showToast(e,"info","Info",4e3)},logError(e,t){n.error("RDP",`${e}:`,t)},emitEvent(e,t={}){try{document.dispatchEvent(new CustomEvent("rdp:"+e,{detail:t}))}catch(i){n.debug("Event",`Dispatch failed: ${i.message}`)}}};var B={initAudio(){this.audioContext=null,this.audioEnabled=!1,this.audioFormat=null,this.audioQueue=[],this.audioPlaying=!1,this.audioGain=null,this.audioVolume=1,this.audioBufferSize=4096,this.audioSampleRate=44100,this.audioChannels=2,this.audioBitsPerSample=16},enableAudio(){if(!this.audioContext)try{this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.audioGain=this.audioContext.createGain(),this.audioGain.connect(this.audioContext.destination),this.audioGain.gain.value=this.audioVolume,this.audioEnabled=!0,Logger.info("Audio",`Initialized: ${this.audioContext.sampleRate}Hz`)}catch(e){Logger.error("Audio",`Failed to initialize: ${e.message}`),this.audioEnabled=!1}},disableAudio(){this.audioContext&&(this.audioContext.close(),this.audioContext=null),this.audioEnabled=!1,this.audioQueue=[],Logger.info("Audio","Disabled")},setAudioVolume(e){this.audioVolume=Math.max(0,Math.min(1,e)),this.audioGain&&(this.audioGain.gain.value=this.audioVolume)},handleAudioMessage(e){if(!this.audioEnabled||!this.audioContext||e.length<4)return;let t=new DataView(e.buffer,e.byteOffset,e.byteLength),i=e[1],s=t.getUint16(2,!0),o=4;i===2&&e.length>=12&&(this.audioChannels=t.getUint16(4,!0),this.audioSampleRate=t.getUint32(6,!0),this.audioBitsPerSample=t.getUint16(10,!0),o=12,Logger.info("Audio",`Format: ${this.audioSampleRate}Hz ${this.audioChannels}ch ${this.audioBitsPerSample}bit`));let a=e.slice(o);a.length!==0&&this.queueAudio(a,s)},queueAudio(e,t){let i=this.pcmToFloat32(e);if(!i||i.length===0)return;let s=Math.floor(i.length/this.audioChannels);if(s!==0)try{let o=this.audioContext.createBuffer(this.audioChannels,s,this.audioSampleRate);for(let a=0;a<this.audioChannels;a++){let l=o.getChannelData(a);for(let d=0;d<s;d++)l[d]=i[d*this.audioChannels+a]}this.audioQueue.push({buffer:o,timestamp:t}),this.audioPlaying||this.playNextAudio()}catch(o){Logger.error("Audio",`Buffer creation failed: ${o.message}`)}},pcmToFloat32(e){let t=new DataView(e.buffer,e.byteOffset,e.byteLength),i=[];if(this.audioBitsPerSample===16){let s=Math.floor(e.length/2);for(let o=0;o<s;o++){let a=t.getInt16(o*2,!0);i.push(a/32768)}}else if(this.audioBitsPerSample===8)for(let s=0;s<e.length;s++){let o=e[s];i.push((o-128)/128)}else return Logger.warn("Audio",`Unsupported bit depth: ${this.audioBitsPerSample}`),null;return i},playNextAudio(){if(this.audioQueue.length===0){this.audioPlaying=!1;return}this.audioPlaying=!0;let e=this.audioQueue.shift(),t=this.audioContext.createBufferSource();t.buffer=e.buffer,t.connect(this.audioGain),t.onended=()=>{this.playNextAudio()};let i=this.audioContext.currentTime;t.start(i)},resumeAudioContext(){this.audioContext&&this.audioContext.state==="suspended"&&this.audioContext.resume().then(()=>{Logger.info("Audio","Context resumed")})}},x=B;function m(e){Object.keys(e).forEach(t=>{typeof e[t]=="function"&&(u.prototype[t]=e[t])})}function u(e,t,i,s,o){this.websocketURL=e,this.canvas=document.getElementById(t),this.hostEl=document.getElementById(i),this.userEl=document.getElementById(s),this.passwordEl=document.getElementById(o),this.ctx=this.canvas.getContext("2d"),this.pointerCacheCanvas=document.getElementById("pointer-cache"),this.pointerCacheCanvasCtx=this.pointerCacheCanvas.getContext("2d"),this.connected=!1,this.socket=null,this.initSession(),this.initInput(),this.initGraphics(),this.initUI(),this.initAudio(),this.initialize=this.initialize.bind(this),this.handleMessage=this.handleMessage.bind(this),this.deinitialize=this.deinitialize.bind(this),this.loadSession(),this.shouldAutoReconnect()&&this.scheduleReconnect(100)}m(y);m(E);m(b);m(T);m(M);m(x);u.prototype.connect=function(){if(this.socket&&this.socket.readyState===WebSocket.OPEN){n.warn("Connection","Already established");return}let e=this.sanitizeInput(this.hostEl.value),t=this.sanitizeInput(this.userEl.value),i=this.passwordEl.value;if(!this.validateHostname(e)){n.error("Connection","Invalid hostname format");return}this.reconnectAttempts=0,this.manualDisconnect=!1,this.lastConnectionTime=Date.now(),this.csrfToken=this.generateCSRFToken();let s=window.innerWidth,o=window.innerHeight;this.originalWidth=s,this.originalHeight=o,this.canvas.width=s,this.canvas.height=o;let a=document.getElementById("colorDepth"),l=a?a.value:"16",d=document.getElementById("disableNLA"),f=d?d.checked:!1,v=document.getElementById("enableAudio"),w=v?v.checked:!1;n.info("Connection",`Connecting to ${e} as ${t} (${s}x${o}, ${l}bpp)`);let p=new URL(this.websocketURL);p.searchParams.set("width",s),p.searchParams.set("height",o),p.searchParams.set("colorDepth",l),f&&(p.searchParams.set("disableNLA","true"),n.info("Connection","NLA disabled")),w&&(p.searchParams.set("audio","true"),this.enableAudio(),n.info("Audio","Audio redirection enabled")),this._pendingCredentials={host:e,user:t,password:i},this.socket=new WebSocket(p.toString()),this.socket.onopen=()=>{if(n.info("Connection","WebSocket opened, sending credentials"),this._pendingCredentials){let r=JSON.stringify({type:"credentials",host:this._pendingCredentials.host,user:this._pendingCredentials.user,password:this._pendingCredentials.password});this.socket.send(r),this._pendingCredentials=null}this.initialize()},this.socket.onmessage=r=>{r.data.arrayBuffer().then(c=>this.handleMessage(c))},this.socket.onerror=r=>{let c=r.message||"";this.logError("WebSocket connection error",{error:c,code:r.code}),c.includes("401")||c.includes("Unauthorized")?this.showUserError("Authentication failed: Invalid username or password"):c.includes("403")||c.includes("Forbidden")?this.showUserError("Access denied: You do not have permission to connect"):c.includes("404")||c.includes("Not Found")?this.showUserError("Server not found: Check the server address"):c.includes("timeout")?this.showUserError("Connection timeout: Server is not responding"):this.showUserError("Connection failed: Unable to connect to server"),this.emitEvent("error",{message:c,code:r.code})},this.socket.onclose=r=>{if(n.info("Connection",`WebSocket closed (code=${r.code}, reason=${r.reason||"none"})`),this.emitEvent("disconnected",{code:r.code,reason:r.reason,wasClean:r.wasClean,manual:this.manualDisconnect}),this.manualDisconnect){this.showUserSuccess("Disconnected successfully");return}if(r.code!==1e3){if(r.code===1001?this.showUserError("Connection closed: Going away"):r.code===1002?this.showUserError("Connection closed: Protocol error"):r.code===1003?this.showUserError("Connection closed: Unsupported data type"):r.code===1006?this.showUserError("Connection closed abnormally: Check your network connection"):r.code===1015?this.showUserError("TLS handshake failed: Certificate validation error"):this.showUserError(`Connection lost (code: ${r.code})`),!this.manualDisconnect&&this.reconnectAttempts<this.maxReconnectAttempts){let c=this.reconnectDelay*Math.pow(2,this.reconnectAttempts);this.scheduleReconnect(Math.min(c,3e4))}this.deinitialize()}},this.saveSession()};u.prototype.sendAuthentication=function(){if(!this.socket||this.socket.readyState!==WebSocket.OPEN){this.showUserError("Connection lost during authentication");return}try{let e={type:"auth",user:this.sanitizeInput(this.userEl.value),password:this.passwordEl.value,host:this.sanitizeInput(this.hostEl.value),sessionId:this.sessionId,csrfToken:this.csrfToken,timestamp:Date.now()};this.socket.send(JSON.stringify(e)),n.debug("Connection","Authentication data sent")}catch(e){this.showUserError("Failed to send authentication data"),n.error("Connection","Authentication send error:",e)}};u.prototype.initialize=function(){this.connected||(this.reconnectAttempts=0,this.lastConnectionTime=Date.now(),window.addEventListener("keydown",this.handleKeyDown),window.addEventListener("keyup",this.handleKeyUp),this.canvas.addEventListener("mousemove",this.handleMouseMove),this.canvas.addEventListener("mousedown",this.handleMouseDown),this.canvas.addEventListener("mouseup",this.handleMouseUp),this.canvas.addEventListener("contextmenu",this.handleMouseUp),this.canvas.addEventListener("click",()=>{this.canvas.focus(),this.resumeAudioContext()}),this.canvas.addEventListener("wheel",this.handleWheel),this.canvas.addEventListener("touchstart",this.handleTouchStart,{passive:!1}),this.canvas.addEventListener("touchmove",this.handleTouchMove,{passive:!1}),this.canvas.addEventListener("touchend",this.handleTouchEnd,{passive:!1}),window.addEventListener("resize",this.handleResize),this.connected=!0)};u.prototype.showCanvas=function(){let e=document.getElementById("canvas-container"),t=document.querySelector(".container");t&&(t.style.display="none"),e&&(e.style.cssText="display: block !important; position: fixed !important; top: 0 !important; left: 0 !important; width: 100vw !important; height: 100vh !important; z-index: 9999 !important; background: #000 !important;",e.offsetHeight),this.canvas.style.cssText="display: block !important; visibility: visible !important; opacity: 1 !important; position: absolute !important; top: 0 !important; left: 0 !important; width: "+this.canvas.width+"px !important; height: "+this.canvas.height+"px !important;",this.canvas.setAttribute("tabindex","0"),this.canvas.style.outline="none",this.canvas.focus(),this.canvas.offsetHeight,this.initBitmapCache(),this.initClipboardSupport(),this.startTimeoutTracking(),this.emitEvent("connected",{host:this.sanitizeInput(this.hostEl.value),user:this.sanitizeInput(this.userEl.value)})};u.prototype.deinitialize=function(){this.connected=!1,this.canvasShown=!1,window.removeEventListener("keydown",this.handleKeyDown),window.removeEventListener("keyup",this.handleKeyUp),this.canvas.removeEventListener("mousemove",this.handleMouseMove),this.canvas.removeEventListener("mousedown",this.handleMouseDown),this.canvas.removeEventListener("mouseup",this.handleMouseUp),this.canvas.removeEventListener("contextmenu",this.handleMouseUp),this.canvas.removeEventListener("wheel",this.handleWheel),this.canvas.removeEventListener("touchstart",this.handleTouchStart),this.canvas.removeEventListener("touchmove",this.handleTouchMove),this.canvas.removeEventListener("touchend",this.handleTouchEnd),window.removeEventListener("resize",this.handleResize),this.clearAllTimeouts(),this.clearBitmapCache(),this.disableAudio(),Object.entries(this.pointerCache).forEach(([e,t])=>{document.getElementsByTagName("head")[0].removeChild(t)}),this.pointerCache={},this.canvas.classList=[],this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)};u.prototype.handleMessage=function(e){if(!this.connected)return;if(new Uint8Array(e)[0]===254&&this.audioEnabled){this.handleAudioMessage(new Uint8Array(e));return}try{let o=new TextDecoder().decode(e),a=JSON.parse(o);if(a.type==="clipboard_response"){n.info("Clipboard","Received remote clipboard data"),this.handleRemoteClipboard(a.data);return}if(a.type==="file_transfer_status"){this.updateFileStatus(a.message);return}if(a.type==="error"){this.showUserError(a.message),this.emitEvent("error",{message:a.message});return}if(a.type==="capabilities"){a.logLevel&&(n.setLevel(a.logLevel),n.info("Config",`Log level synced: ${a.logLevel}`)),n.info("Capabilities",`Server: codecs=${a.codecs?.join(",")||"none"}, colorDepth=${a.colorDepth}, desktop=${a.desktopSize}`),this.serverCapabilities=a;return}}catch{}let i=new BinaryReader(e),s=parseUpdateHeader(i);if(n.debug("Update",`code=${s.updateCode}, pointer=${s.isPointer()}`),s.isCompressed()){n.warn("Update","Compression not supported");return}if(s.isBitmap()){this.handleBitmap(i);return}if(s.isPointer()){this.handlePointer(s,i);return}if(s.isSynchronize()){n.debug("Update","Synchronize received");return}if(s.isPalette()){this.handlePalette(i);return}s.updateCode!==15&&n.debug("Update",`Unknown update code: ${s.updateCode}`)};u.prototype.disconnect=function(){this.socket&&(this.manualDisconnect=!0,this.clearSession(),this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=null),this.deinitialize(),this.socket.close(1e3))};u.prototype.reconnectWithNewSize=function(e,t){this.originalWidth=e,this.originalHeight=t,this.socket&&(this.manualDisconnect=!0,this.socket.close(1e3)),setTimeout(()=>{this.manualDisconnect=!1,this.connect()},500)};typeof window<"u"&&(window.Client=u,window.Logger=n);var P=u;return A(z);})();
