# RDP HTML5 Client Architecture

> Comprehensive Technical Documentation  
> Last Updated: January 20, 2026

## Table of Contents

1. [Overview](#overview)
2. [System Architecture](#system-architecture)
3. [Data Flow](#data-flow)
4. [Backend Components](#backend-components)
5. [Protocol Stack](#protocol-stack)
6. [UDP Transport](#udp-transport)
7. [Frontend Components](#frontend-components)
8. [Authentication System](#authentication-system)
9. [Audio Subsystem](#audio-subsystem)
10. [Configuration Management](#configuration-management)
11. [Security Considerations](#security-considerations)
12. [Performance Optimizations](#performance-optimizations)
13. [Deployment](#deployment)

---

## Overview

This project implements a browser-based Remote Desktop Protocol (RDP) client using:

- **Go** backend server acting as an RDP-to-WebSocket bridge
- **WebAssembly** module for high-performance bitmap decompression
- **HTML5 Canvas** for rendering remote desktop display
- **Web Audio API** for audio redirection

### Key Capabilities

| Feature        | Status | Description                             |
| -------------- | ------ | --------------------------------------- |
| Display        | âœ…     | FastPath and slow-path bitmap updates   |
| Input          | âœ…     | Mouse and keyboard via FastPath         |
| Authentication | âœ…     | NLA (CredSSP/NTLMv2), TLS, standard RDP |
| Color Depths   | âœ…     | 8, 15, 16, 24, 32-bit                   |
| Codecs         | âœ…     | RLE, NSCodec, Planar, RemoteFX          |
| Audio          | âœ…     | RDPSND channel with PCM and MP3 output  |
| Clipboard      | âœ…     | Text copy/paste                         |
| UDP Transport  | ğŸ”§     | Experimental, MS-RDPEUDP/MS-RDPEMT      |

---

## System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                 Browser                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                           HTML5 Client                              â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚  Canvas  â”‚  â”‚  Input   â”‚  â”‚  Audio   â”‚  â”‚   WebSocket API    â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ Renderer â”‚  â”‚ Handler  â”‚  â”‚ Playback â”‚  â”‚                    â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â”‚       â”‚             â”‚             â”‚                  â”‚              â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚                    WASM Module (TinyGo)                       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  RLE Decompress â”‚ NSCodec â”‚ Color Convert â”‚ Bitmap Flip       â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â”‚ WebSocket (Binary)
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            Go Backend Server                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                       WebSocket Handler                             â”‚  â”‚
â”‚  â”‚                   (internal/handler/connect.go)                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                  â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                         RDP Client Core                             â”‚  â”‚
â”‚  â”‚                      (internal/rdp/client.go)                       â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚   Connect   â”‚  â”‚  GetUpdate  â”‚  â”‚  SendInput  â”‚  â”‚   Audio    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   Manager   â”‚  â”‚   Reader    â”‚  â”‚   Writer    â”‚  â”‚  Handler   â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚            â”‚                â”‚                â”‚               â”‚            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                        Protocol Stack                               â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚  â”‚
â”‚  â”‚  â”‚ FastPath â”‚  â”‚   PDU    â”‚  â”‚   MCS    â”‚  â”‚   GCC    â”‚             â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜             â”‚  â”‚
â”‚  â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚  â”‚
â”‚  â”‚                             â”‚                                       â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚                      X.224 / TPKT                             â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â”‚ TCP :3389
                                      â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚      RDP Server         â”‚
                        â”‚  (Windows / XRDP)       â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow

### Connection Establishment

```
Browser                    Go Server                 RDP Server
   â”‚                          â”‚                          â”‚
   â”‚â”€â”€GET /connect?paramsâ”€â”€â”€â”€â–¶â”‚                          â”‚
   â”‚                          â”‚â”€â”€TCP Connectâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚                          â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                          â”‚                          â”‚
   â”‚                          â”‚â”€â”€X.224 Connection Reqâ”€â”€â”€â–¶â”‚
   â”‚                          â”‚â—€â”€X.224 Connection Confâ”€â”€â”€â”‚
   â”‚                          â”‚                          â”‚
   â”‚                          â”‚â•â•TLS Handshakeâ•â•â•â•â•â•â•â•â•â•â–¶â”‚
   â”‚                          â”‚â—€â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚
   â”‚                          â”‚                          â”‚
   â”‚                          â”‚â”€â”€NLA (if enabled)â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚                          â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                          â”‚                          â”‚
   â”‚                          â”‚â”€â”€MCS Connect-Initialâ”€â”€â”€â”€â–¶â”‚
   â”‚                          â”‚â—€â”€MCS Connect-Responseâ”€â”€â”€â”€â”‚
   â”‚                          â”‚                          â”‚
   â”‚                          â”‚â”€â”€Channel Joinâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚                          â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                          â”‚                          â”‚
   â”‚                          â”‚â”€â”€Client Infoâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚                          â”‚â—€â”€License Responseâ”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                          â”‚                          â”‚
   â”‚                          â”‚â”€â”€Capability Confirmâ”€â”€â”€â”€â”€â–¶â”‚
   â”‚                          â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                          â”‚                          â”‚
   â”‚â—€â”€WebSocket Upgradeâ”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚
   â”‚                          â”‚                          â”‚
   â”‚â—€â”€Capabilities JSONâ”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚
   â”‚                          â”‚                          â”‚
```

### Runtime Data Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Incoming (RDP â†’ Browser)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                    â”‚
â”‚  RDP Server                                                        â”‚
â”‚      â”‚                                                             â”‚
â”‚      â–¼                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ FastPath/X.224 Update                                        â”‚  â”‚
â”‚  â”‚ â€¢ Bitmap data (compressed)                                   â”‚  â”‚
â”‚  â”‚ â€¢ Pointer updates                                            â”‚  â”‚
â”‚  â”‚ â€¢ Palette changes                                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚      â”‚                                                             â”‚
â”‚      â–¼                                                             â”‚
â”‚  GetUpdate() [internal/rdp/get_update.go]                          â”‚
â”‚      â”‚                                                             â”‚
â”‚      â–¼                                                             â”‚
â”‚  rdpToWs() [internal/handler/connect.go]                           â”‚
â”‚      â”‚                                                             â”‚
â”‚      â–¼                                                             â”‚
â”‚  WebSocket.Send() â†’ Binary message                                 â”‚
â”‚      â”‚                                                             â”‚
â”‚      â–¼                                                             â”‚
â”‚  handleMessage() [web/src/js/client.js]                            â”‚
â”‚      â”‚                                                             â”‚
â”‚      â”œâ”€â”€â–¶ parseBitmapUpdate()                                      â”‚
â”‚      â”‚        â”‚                                                    â”‚
â”‚      â”‚        â–¼                                                    â”‚
â”‚      â”‚   goRLE.processBitmap() [WASM]                              â”‚
â”‚      â”‚        â”‚                                                    â”‚
â”‚      â”‚        â–¼                                                    â”‚
â”‚      â”‚   ctx.putImageData() [Canvas]                               â”‚
â”‚      â”‚                                                             â”‚
â”‚      â””â”€â”€â–¶ parsePointerUpdate() â†’ Update cursor                     â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Outgoing (Browser â†’ RDP)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                    â”‚
â”‚  User Input (mouse move, click, keypress)                          â”‚
â”‚      â”‚                                                             â”‚
â”‚      â–¼                                                             â”‚
â”‚  Input handler [web/src/js/input.js]                               â”‚
â”‚      â”‚                                                             â”‚
â”‚      â–¼                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ FastPath Input PDU                                           â”‚  â”‚
â”‚  â”‚ â€¢ Mouse: flags (2) + X (2) + Y (2)                           â”‚  â”‚
â”‚  â”‚ â€¢ Keyboard: flags (1) + keyCode (2)                          â”‚  â”‚
â”‚  â”‚ â€¢ Sync: flags (2)                                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚      â”‚                                                             â”‚
â”‚      â–¼                                                             â”‚
â”‚  WebSocket.Send() â†’ Binary message                                 â”‚
â”‚      â”‚                                                             â”‚
â”‚      â–¼                                                             â”‚
â”‚  wsToRdp() [internal/handler/connect.go]                           â”‚
â”‚      â”‚                                                             â”‚
â”‚      â–¼                                                             â”‚
â”‚  SendInputEvent() [internal/rdp/send_input_event.go]               â”‚
â”‚      â”‚                                                             â”‚
â”‚      â–¼                                                             â”‚
â”‚  FastPath.Send() â†’ RDP Server                                      â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Backend Components

### Directory Structure

```
cmd/
â””â”€â”€ server/
    â””â”€â”€ main.go              # Entry point, HTTP server setup

internal/
â”œâ”€â”€ auth/                    # NTLMv2/CredSSP authentication
â”‚   â”œâ”€â”€ credssp.go          # TSRequest encoding/decoding
â”‚   â”œâ”€â”€ ntlm.go             # NTLM message generation
â”‚   â””â”€â”€ md4.go              # MD4 hash implementation
â”‚
â”œâ”€â”€ codec/                   # Bitmap compression codecs
â”‚   â”œâ”€â”€ decoder.go          # Main codec dispatcher
â”‚   â”œâ”€â”€ rle8.go             # 8-bit RLE decompression
â”‚   â”œâ”€â”€ rle16.go            # 16-bit RLE decompression
â”‚   â”œâ”€â”€ rle24.go            # 24-bit RLE decompression
â”‚   â”œâ”€â”€ rle32.go            # 32-bit RLE decompression
â”‚   â”œâ”€â”€ nscodec.go          # NSCodec (AYCoCg) decompression
â”‚   â”œâ”€â”€ planar.go           # Planar codec
â”‚   â””â”€â”€ bitmap.go           # Color conversion, flip
â”‚
â”œâ”€â”€ config/                  # Configuration management
â”‚   â””â”€â”€ config.go           # Load from env/flags
â”‚
â”œâ”€â”€ handler/                 # WebSocket handler
â”‚   â””â”€â”€ connect.go          # WSâ†’RDP bridge logic
â”‚
â”œâ”€â”€ logging/                 # Leveled logging
â”‚   â””â”€â”€ logging.go          # Debug/Info/Warn/Error
â”‚
â”œâ”€â”€ protocol/                # RDP protocol stack
â”‚   â”œâ”€â”€ audio/              # RDPSND channel
â”‚   â”œâ”€â”€ encoding/           # BER/PER encoding
â”‚   â”œâ”€â”€ fastpath/           # FastPath I/O
â”‚   â”œâ”€â”€ gcc/                # T.124 GCC
â”‚   â”œâ”€â”€ mcs/                # T.125 MCS
â”‚   â”œâ”€â”€ pdu/                # PDU definitions
â”‚   â”œâ”€â”€ tpkt/               # TPKT framing
â”‚   â””â”€â”€ x224/               # X.224 connection
â”‚
â””â”€â”€ rdp/                     # Core RDP client
    â”œâ”€â”€ client.go           # Client struct, initialization
    â”œâ”€â”€ connect.go          # Connection sequence
    â”œâ”€â”€ nla.go              # NLA authentication
    â”œâ”€â”€ audio.go            # Audio handler
    â”œâ”€â”€ get_update.go       # Receive updates
    â”œâ”€â”€ send_input_event.go # Send input
    â””â”€â”€ capabilities.go     # Capability negotiation
```

### RDP Client Core

The `Client` struct in `internal/rdp/client.go` manages the RDP session:

```go
type Client struct {
    // Network
    conn       net.Conn
    buffReader *bufio.Reader

    // Protocol layers
    tpktLayer    *tpkt.Protocol
    x224Layer    *x224.Protocol
    mcsLayer     MCSLayer
    fastPath     *fastpath.FastPath

    // Session state
    userID            uint16
    channelIDMap      map[string]uint16
    selectedProtocol  pdu.NegotiationProtocol

    // Configuration
    desktopWidth  int
    desktopHeight int
    colorDepth    int
    useNLA        bool

    // Handlers
    audioHandler  *AudioHandler
}
```

### Connection Sequence

The connection follows MS-RDPBCGR specification:

```go
func (c *Client) Connect() error {
    // Phase 1: Connection Initiation
    c.connectionInitiation()  // X.224 + protocol negotiation

    // Phase 2: Basic Settings Exchange
    c.basicSettingsExchange() // MCS Connect + GCC

    // Phase 3: Channel Connection
    c.channelConnection()     // Erect domain, attach user, join channels

    // Phase 4: Secure Settings Exchange
    c.secureSettingsExchange() // Client Info PDU

    // Phase 5: Licensing
    c.licensing()             // License validation

    // Phase 6: Capabilities Exchange
    c.capabilitiesExchange()  // Demand/Confirm Active PDU

    // Phase 7: Connection Finalization
    c.connectionFinalization() // Synchronize, control, font list

    return nil
}
```

---

## Protocol Stack

### Layer Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Application Layer                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ PDU (Protocol Data Units)                               â”‚  â”‚
â”‚  â”‚ â€¢ Share Control Header                                  â”‚  â”‚
â”‚  â”‚ â€¢ Share Data Header                                     â”‚  â”‚
â”‚  â”‚ â€¢ Capability Sets                                       â”‚  â”‚
â”‚  â”‚ â€¢ Input/Output PDUs                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Presentation Layer                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ FastPath (Optimized channel)                            â”‚  â”‚
â”‚  â”‚ â€¢ 1-byte header + data                                  â”‚  â”‚
â”‚  â”‚ â€¢ Bitmap updates (0x01)                                 â”‚  â”‚
â”‚  â”‚ â€¢ Pointer updates (0x04)                                â”‚  â”‚
â”‚  â”‚ â€¢ Input events                                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Session Layer                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ MCS (Multipoint Communication Service) - T.125          â”‚  â”‚
â”‚  â”‚ â€¢ Connect Initial/Response                              â”‚  â”‚
â”‚  â”‚ â€¢ Erect Domain Request                                  â”‚  â”‚
â”‚  â”‚ â€¢ Attach User Request/Confirm                           â”‚  â”‚
â”‚  â”‚ â€¢ Channel Join Request/Confirm                          â”‚  â”‚
â”‚  â”‚ â€¢ Send Data Request/Indication                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ GCC (Generic Conference Control) - T.124                â”‚  â”‚
â”‚  â”‚ â€¢ Conference Create Request/Response                    â”‚  â”‚
â”‚  â”‚ â€¢ Client/Server Core Data                               â”‚  â”‚
â”‚  â”‚ â€¢ Client/Server Security Data                           â”‚  â”‚
â”‚  â”‚ â€¢ Client/Server Network Data                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Transport Layer                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ X.224 (ISO 8073)                                        â”‚  â”‚
â”‚  â”‚ â€¢ Connection Request (0xE0)                             â”‚  â”‚
â”‚  â”‚ â€¢ Connection Confirm (0xD0)                             â”‚  â”‚
â”‚  â”‚ â€¢ Data (0xF0)                                           â”‚  â”‚
â”‚  â”‚ â€¢ Negotiation Request/Response                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ TPKT (RFC 1006)                                         â”‚  â”‚
â”‚  â”‚ â€¢ Version (1 byte) = 0x03                               â”‚  â”‚
â”‚  â”‚ â€¢ Reserved (1 byte) = 0x00                              â”‚  â”‚
â”‚  â”‚ â€¢ Length (2 bytes, big-endian)                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Network Layer                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ TLS 1.0-1.2 (when SSL/Hybrid negotiated)                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ TCP (port 3389)                                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### FastPath Format

FastPath provides optimized update delivery:

```
FastPath Update PDU:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ fpUpdateHeader (1 byte)                                 â”‚
â”‚   bits 0-3: updateCode                                  â”‚
â”‚     0x00 = orders                                       â”‚
â”‚     0x01 = bitmap                                       â”‚
â”‚     0x02 = palette                                      â”‚
â”‚     0x03 = synchronize                                  â”‚
â”‚     0x04 = surface commands                             â”‚
â”‚     0x05 = pointer (hidden)                             â”‚
â”‚     0x06 = pointer (default)                            â”‚
â”‚     0x09 = pointer (new)                                â”‚
â”‚   bits 4-5: fragmentation                               â”‚
â”‚   bits 6-7: compression                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ size (1-2 bytes, variable)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ updateData (variable)                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## UDP Transport

The client supports optional UDP transport for improved performance over high-latency networks. UDP transport is implemented per MS-RDPEUDP and MS-RDPEMT specifications.

> **See also**: [UDP Transport Documentation](UDP.md) for detailed protocol information.

### Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                             RDP Client                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                   MultitransportHandler                         â”‚  â”‚
â”‚  â”‚  - Handles Initiate Multitransport Request/Response             â”‚  â”‚
â”‚  â”‚  - Manages TunnelManager for UDP connections                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                  â”‚                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                      TunnelManager                              â”‚  â”‚
â”‚  â”‚  - Creates Tunnel instances per server request                  â”‚  â”‚
â”‚  â”‚  - Handles tunnel lifecycle and data routing                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                  â”‚                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                 SecureConnection (TLS/DTLS)                     â”‚  â”‚
â”‚  â”‚                             â”‚                                   â”‚  â”‚
â”‚  â”‚                 Connection (MS-RDPEUDP)                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Key Features

| Feature                    | Description                                         |
| -------------------------- | --------------------------------------------------- |
| Reliable Transport         | TLS-secured, sequenced delivery with retransmission |
| Lossy Transport            | DTLS-secured, best-effort delivery for bulk data    |
| Multitransport Negotiation | Server-initiated, client can accept or decline      |
| Automatic Fallback         | Declines UDP requests when disabled (E_ABORT)       |

### Enabling UDP

```bash
# Environment variable
export RDP_ENABLE_UDP=true

# Command-line flag
./rdp-html5 -udp
```

### Connection Flow

1. Server sends Initiate Multitransport Request PDU (via MCS I/O channel)
2. Client attempts UDP connection to server:3389
3. MS-RDPEUDP 3-way handshake (SYN â†’ SYN+ACK â†’ ACK)
4. TLS/DTLS handshake over UDP
5. Tunnel Create Request/Response PDU exchange
6. Client sends Initiate Multitransport Response PDU (success or decline)

---

## Frontend Components

### Directory Structure

```
web/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.html          # Main HTML page
â”‚   â”œâ”€â”€ js/
â”‚   â”‚   â”œâ”€â”€ client.js       # Main client class
â”‚   â”‚   â”œâ”€â”€ session.js      # Connection management
â”‚   â”‚   â”œâ”€â”€ input.js        # Mouse/keyboard handling
â”‚   â”‚   â”œâ”€â”€ graphics.js     # Bitmap processing
â”‚   â”‚   â”œâ”€â”€ renderer.js     # Renderer interface (Canvas/WebGL)
â”‚   â”‚   â”œâ”€â”€ webgl-renderer.js # WebGL1/2 renderer
â”‚   â”‚   â”œâ”€â”€ clipboard.js    # Copy/paste
â”‚   â”‚   â”œâ”€â”€ ui.js           # UI state
â”‚   â”‚   â”œâ”€â”€ audio.js        # Audio playback (PCM/MP3)
â”‚   â”‚   â”œâ”€â”€ wasm.js         # WASM codec wrapper
â”‚   â”‚   â””â”€â”€ codec-fallback.js # Pure JS fallback codecs
â”‚   â””â”€â”€ wasm/
â”‚       â””â”€â”€ main.go         # TinyGo WASM module
â””â”€â”€ dist/                   # Built/bundled assets
```

### Client Architecture

The JavaScript client uses a mixin-based architecture:

```javascript
// web/src/js/client.js
import { SessionMixin } from "./session.js";
import { InputMixin } from "./input.js";
import { GraphicsMixin } from "./graphics.js";
import { ClipboardMixin } from "./clipboard.js";
import { UIMixin } from "./ui.js";
import AudioMixin from "./audio.js";

function Client(websocketURL, canvasID, hostID, userID, passwordID) {
  this.websocketURL = websocketURL;
  this.canvas = document.getElementById(canvasID);
  this.ctx = this.canvas.getContext("2d");
  this.socket = null;

  // Initialize all mixins
  this.initSession();
  this.initInput();
  this.initGraphics();
  this.initUI();
  this.initAudio();
}

// Apply mixins to prototype
applyMixin(SessionMixin);
applyMixin(InputMixin);
applyMixin(GraphicsMixin);
applyMixin(ClipboardMixin);
applyMixin(UIMixin);
applyMixin(AudioMixin);
```

### WASM Module

The TinyGo WASM module exposes codec functions to JavaScript:

```go
// web/src/wasm/main.go
func main() {
    js.Global().Set("goRLE", js.ValueOf(map[string]interface{}{
        "decompressRLE16": js.FuncOf(jsDecompressRLE16),
        "flipVertical":    js.FuncOf(jsFlipVertical),
        "rgb565toRGBA":    js.FuncOf(jsRGB565toRGBA),
        "bgr24toRGBA":     js.FuncOf(jsBGR24toRGBA),
        "bgra32toRGBA":    js.FuncOf(jsBGRA32toRGBA),
        "processBitmap":   js.FuncOf(jsProcessBitmap),
        "decodeNSCodec":   js.FuncOf(jsDecodeNSCodec),
        "setPalette":      js.FuncOf(jsSetPalette),
        "decodeRFXTile":   js.FuncOf(jsDecodeRFXTile),
        "setRFXQuant":     js.FuncOf(jsSetRFXQuant),
    }))

    <-c // Keep alive
}
```

### JavaScript Fallback Codecs

When WASM is unavailable (older browsers, disabled WebAssembly), the client falls back to pure JavaScript implementations:

```javascript
// web/src/js/codec-fallback.js
const FallbackCodec = {
  rgb565ToRGBA(src, dst) {
    /* ... */
  },
  rgb555ToRGBA(src, dst) {
    /* ... */
  },
  bgr24ToRGBA(src, dst) {
    /* ... */
  },
  bgra32ToRGBA(src, dst) {
    /* ... */
  },
  palette8ToRGBA(src, dst) {
    /* ... */
  },
  flipVertical(data, width, height, bytesPerPixel) {
    /* ... */
  },
  processBitmap(src, width, height, bpp, isCompressed, dst) {
    /* ... */
  },
};
```

**Fallback Limitations:**

- Compressed formats (RLE, NSCodec, RemoteFX) not supported
- Recommend 16-bit color depth for best performance
- ~2-5x slower than WASM for color conversion

### Capabilities Detection

Upon connection, the client logs its capabilities:

```
[RDP Client] Capabilities
  WASM: âœ“ loaded
  Codecs: RemoteFX, RLE, NSCodec
  Display: 1920Ã—1080
  Color: 32bpp
```

### Bitmap Processing Pipeline

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Bitmap Processing Pipeline                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Compressed Bitmap from Server
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Detect Compression  â”‚
â”‚ â€¢ RLE (most common) â”‚
â”‚ â€¢ NSCodec           â”‚
â”‚ â€¢ Planar            â”‚
â”‚ â€¢ Uncompressed      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  goRLE.processBitmapâ”‚â”€â”€â”€â”€â–¶â”‚ 1. Decompress       â”‚
â”‚  (WASM)             â”‚     â”‚ 2. Flip vertical    â”‚
â”‚                     â”‚     â”‚ 3. Convert to RGBA  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ImageData object    â”‚
â”‚ (width Ã— height Ã— 4)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ctx.putImageData()  â”‚
â”‚ at (destLeft,       â”‚
â”‚     destTop)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Authentication System

### Authentication Methods

| Method        | Protocol     | Security Level |
| ------------- | ------------ | -------------- |
| Standard RDP  | None         | Low (legacy)   |
| TLS           | SSL/TLS      | Medium         |
| NLA (CredSSP) | TLS + NTLMv2 | High           |

### NLA Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    NLA Authentication Flow                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Client                                                     Server
   â”‚                                                          â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ TLS Handshake â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                                                          â”‚
   â”‚  TSRequest (version=6, negoTokens=[NTLM Negotiate])      â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚                                                          â”‚
   â”‚  TSRequest (version=6, negoTokens=[NTLM Challenge])      â”‚
   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                                                          â”‚
   â”‚  TSRequest (negoTokens=[NTLM Auth], pubKeyAuth)          â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚                                                          â”‚
   â”‚  TSRequest (pubKeyAuth verified)                         â”‚
   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                                                          â”‚
   â”‚  TSRequest (authInfo=[encrypted credentials])            â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚                                                          â”‚
   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Continue RDP Connection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚                                                          â”‚
```

### NTLM Message Structure

```go
// internal/auth/ntlm.go

// Negotiate Message (Type 1)
type NegotiateMessage struct {
    Signature     [8]byte  // "NTLMSSP\0"
    MessageType   uint32   // 0x00000001
    NegotiateFlags uint32  // NTLM capabilities
    DomainName    Field    // Optional
    Workstation   Field    // Optional
    Version       [8]byte  // OS version
}

// Challenge Message (Type 2) - from server
type ChallengeMessage struct {
    Signature      [8]byte
    MessageType    uint32   // 0x00000002
    TargetName     Field
    NegotiateFlags uint32
    ServerChallenge [8]byte // 8-byte nonce
    Reserved       [8]byte
    TargetInfo     Field    // AV_PAIR list
}

// Authenticate Message (Type 3)
type AuthenticateMessage struct {
    Signature         [8]byte
    MessageType       uint32  // 0x00000003
    LmChallengeResponse Field
    NtChallengeResponse Field
    DomainName        Field
    UserName          Field
    Workstation       Field
    EncryptedRandomSession Field
    NegotiateFlags    uint32
    MIC               [16]byte
}
```

---

## Audio Subsystem

### Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Audio Subsystem                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

RDP Server (RDPSND Virtual Channel)
         â”‚
         â”‚ SNDC_FORMATS (server audio formats)
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AudioHandler (internal/rdp/audio.go)                          â”‚
â”‚                                                               â”‚
â”‚  handleServerFormats()                                        â”‚
â”‚    â€¢ Parse available formats                                  â”‚
â”‚    â€¢ Select format (prefer PCM for low latency, MP3 fallback) â”‚
â”‚    â€¢ Send SNDC_FORMATS response                               â”‚
â”‚                                                               â”‚
â”‚  handleTraining()                                             â”‚
â”‚    â€¢ Respond with SNDC_TRAINING_CONFIRM                       â”‚
â”‚                                                               â”‚
â”‚  handleWave() / handleWave2()                                 â”‚
â”‚    â€¢ Extract audio data                                       â”‚
â”‚    â€¢ Call callback with audio data + format info              â”‚
â”‚    â€¢ Send SNDC_WAVE_CONFIRM                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ AudioCallback(data, format, timestamp)
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WebSocket Handler (internal/handler/connect.go)               â”‚
â”‚                                                               â”‚
â”‚  sendAudioData()                                              â”‚
â”‚    â€¢ Build audio message: 0xFE marker + format + data         â”‚
â”‚    â€¢ Include format tag to identify PCM vs MP3                â”‚
â”‚    â€¢ Send over WebSocket                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ WebSocket binary message
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Audio handler (web/src/js/audio.js)                           â”‚
â”‚                                                               â”‚
â”‚  initAudio()                                                  â”‚
â”‚    â€¢ Create AudioContext                                      â”‚
â”‚    â€¢ Set sample rate from format                              â”‚
â”‚                                                               â”‚
â”‚  handleAudioMessage()                                         â”‚
â”‚    â€¢ Parse format info (including format tag)                 â”‚
â”‚    â€¢ Route to appropriate decoder based on format:            â”‚
â”‚      - PCM: Direct decode to Float32                          â”‚
â”‚      - MP3: Decode via decodeAudioData() (async)              â”‚
â”‚    â€¢ Schedule playback via AudioBufferSourceNode              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Supported Audio Formats

| Format Tag | Name                   | Support     | Notes                              |
| ---------- | ---------------------- | ----------- | ---------------------------------- |
| 0x0001     | WAVE_FORMAT_PCM        | âœ… Primary  | Preferred for low latency          |
| 0x0055     | WAVE_FORMAT_MPEGLAYER3 | âœ… Fallback | ~10x bandwidth savings vs PCM      |
| 0x0011     | WAVE_FORMAT_ADPCM      | âŒ          |                                    |
| 0xFFFE     | WAVE_FORMAT_EXTENSIBLE | âŒ          |                                    |

### Format Selection Strategy

1. **PCM is preferred** when available (16-bit, 44.1kHz, stereo ideal)
   - Direct playback with no decode overhead
   - Lowest latency for real-time audio

2. **MP3 is used as fallback** when no PCM formats offered
   - Browser decodes via `AudioContext.decodeAudioData()`
   - Slight latency increase (~20-50ms decode time)
   - Significant bandwidth reduction

3. If server offers both, **PCM is always selected** for latency reasons

---

## Configuration Management

### Configuration Structure

```go
// internal/config/config.go

type Config struct {
    Server   ServerConfig
    RDP      RDPConfig
    Security SecurityConfig
    Logging  LoggingConfig
}

type ServerConfig struct {
    Host         string        // Listen address
    Port         string        // Listen port
    ReadTimeout  time.Duration
    WriteTimeout time.Duration
    IdleTimeout  time.Duration
}

type SecurityConfig struct {
    AllowedOrigins    []string
    MaxConnections    int
    EnableTLS         bool
    SkipTLSValidation bool
    TLSServerName     string
    UseNLA            bool
    EnableRateLimit   bool
    RateLimitPerMinute int
}

type LoggingConfig struct {
    Level  string  // debug, info, warn, error
    Format string
    File   string
}
```

### Configuration Sources (Priority Order)

1. **Command-line flags** (highest priority)
2. **Environment variables**
3. **Default values** (lowest priority)

| Setting       | Flag                         | Environment Variable        | Default   |
| ------------- | ---------------------------- | --------------------------- | --------- |
| Host          | `-host`                      | `SERVER_HOST`               | `0.0.0.0` |
| Port          | `-port`                      | `SERVER_PORT`               | `8080`    |
| Log Level     | `-log-level`                 | `LOG_LEVEL`                 | `info`    |
| Skip TLS      | `-tls-skip-verify`           | `TLS_SKIP_VERIFY`           | `false`   |
| Allow any SNI | `-tls-allow-any-server-name` | `TLS_ALLOW_ANY_SERVER_NAME` | `false`   |
| Use NLA       | `-nla`                       | `USE_NLA`                   | `true`    |

---

## Security Considerations

### Transport Security

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Security Layers                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Browser â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Go Server â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ RDP Server
         WSS (optional)                   TLS 1.0-1.2

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Browser â†’ Server                                              â”‚
â”‚ â€¢ WebSocket over HTTPS (recommended for production)           â”‚
â”‚ â€¢ Origin validation (ALLOWED_ORIGINS)                         â”‚
â”‚ â€¢ Rate limiting (configurable)                                â”‚
â”‚ â€¢ Security headers (CSP, X-Frame-Options, etc.)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Server â†’ RDP                                                  â”‚
â”‚ â€¢ TLS encryption (SSL or Hybrid protocol)                     â”‚
â”‚ â€¢ NLA authentication (CredSSP + NTLMv2)                       â”‚
â”‚ â€¢ Certificate validation (configurable)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Security Headers

The server applies these security headers:

```go
w.Header().Set("X-Content-Type-Options", "nosniff")
w.Header().Set("X-Frame-Options", "DENY")
w.Header().Set("X-XSS-Protection", "1; mode=block")
w.Header().Set("Strict-Transport-Security", "max-age=31536000")
w.Header().Set("Referrer-Policy", "strict-origin-when-cross-origin")
w.Header().Set("Content-Security-Policy",
    "default-src 'self'; script-src 'self' 'unsafe-inline' 'wasm-unsafe-eval'; ...")
```

### Credential Handling

As of v1.0.0, credentials are transmitted securely via WebSocket message:

1. Browser opens WebSocket with non-sensitive parameters only (width, height, colorDepth)
2. After WebSocket opens, browser sends credentials as JSON message:
   ```json
   { "type": "credentials", "host": "...", "user": "...", "password": "..." }
   ```
3. Server receives credentials via WebSocket (not visible in URL/logs)
4. Credentials are never stored on server (stateless bridge)
5. Encrypted via NLA/TLS before reaching RDP server

This approach prevents credentials from appearing in:

- Browser history
- Server access logs
- Proxy logs
- Referrer headers

---

## Performance Optimizations

### WASM Acceleration

| Operation        | JavaScript | WASM | Speedup |
| ---------------- | ---------- | ---- | ------- |
| RLE16 decompress | ~50ms      | ~2ms | 25x     |
| Vertical flip    | ~20ms      | ~1ms | 20x     |
| Color conversion | ~30ms      | ~1ms | 30x     |

### Buffer Management

```go
// internal/rdp/client.go
const (
    readBufferSize  = 64 * 1024  // 64KB read buffer
    writeBufferSize = 16 * 1024  // 16KB write buffer
)

// Buffered reader reduces syscall overhead
c.buffReader = bufio.NewReaderSize(c.conn, readBufferSize)
```

### FastPath Optimization

FastPath reduces per-update overhead:

| Mode              | Header Size | Use Case         |
| ----------------- | ----------- | ---------------- |
| Slow Path (X.224) | ~20 bytes   | Connection setup |
| FastPath          | 2-3 bytes   | Runtime updates  |

---

## Deployment

### Docker Container

```dockerfile
FROM golang:1.23-alpine AS builder
WORKDIR /app
COPY . .
RUN go build -o rdp-html5 ./cmd/server

FROM alpine:latest
COPY --from=builder /app/rdp-html5 /app/
COPY --from=builder /app/web /app/web
ENV TLS_SKIP_VERIFY=true
EXPOSE 8080
CMD ["/app/rdp-html5"]
```

### Environment Variables

```bash
# Server configuration
SERVER_HOST=0.0.0.0
SERVER_PORT=8080

# Security
TLS_SKIP_VERIFY=true       # For self-signed RDP certs
USE_NLA=true               # Enable NLA authentication
ALLOWED_ORIGINS=https://example.com

# Logging
LOG_LEVEL=info             # debug, info, warn, error
```

### Health Check

```bash
curl http://localhost:8080/  # Should return HTML
```

---

## Appendix: Message Format Reference

### WebSocket Message Types

| Prefix      | Type            | Direction     | Description            |
| ----------- | --------------- | ------------- | ---------------------- |
| `0x00-0x0F` | FastPath Update | Serverâ†’Client | Bitmap/pointer updates |
| `0xFE`      | Audio Data      | Serverâ†’Client | PCM audio samples      |
| `0xFF`      | JSON Metadata   | Serverâ†’Client | Capabilities, errors   |
| (none)      | Input Event     | Clientâ†’Server | Mouse/keyboard         |

### Capability Message

```json
{
  "type": "capabilities",
  "codecs": ["nscodec", "remotefx"],
  "surfaceCommands": true,
  "colorDepth": 32,
  "desktopSize": "1920x1080",
  "multifragmentSize": 65536,
  "largePointer": true,
  "frameAcknowledge": true
}
```

---

## References

- [MS-RDPBCGR](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpbcgr) - RDP Basic Connectivity
- [MS-RDPEGDI](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpegdi) - Graphics Device Interface
- [MS-RDPEFS](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpefs) - File System Virtual Channel
- [MS-RDPEA](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpea) - Audio Output Virtual Channel
- [MS-CSSP](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-cssp) - Credential Security Support Provider
- [RFC 1006](https://tools.ietf.org/html/rfc1006) - TPKT
- [ITU-T T.124](https://www.itu.int/rec/T-REC-T.124) - GCC
- [ITU-T T.125](https://www.itu.int/rec/T-REC-T.125) - MCS
